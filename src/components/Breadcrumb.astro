---
import { SEGMENT_LABELS } from '~/helpers/breadcrumbs';
import VersionSelector from '~/components/VersionSelector.astro';

interface Props {
	pageTitle?: string;
	is404?: boolean;
	pluginSlug?: string;
	currentVersion?: string;
}

const { pageTitle, is404 = false, pluginSlug, currentVersion } = Astro.props;

const pathname = Astro.url.pathname;
const isHomepage = pathname === '/';

const show = !isHomepage && !is404 && pageTitle;

const crumbs: Array<{ name: string; path: string }> = [];
if (show) {
	crumbs.push({ name: 'Accueil', path: '/' });
	let segments = pathname.split('/').filter(Boolean);
	// When a version selector is active, strip the version segment (e.g. "2.0.0")
	// so the breadcrumb stays: Home > Documentation > Plugin Name > [version dropdown]
	if (pluginSlug && currentVersion && segments.length > 0) {
		const lastSeg = segments[segments.length - 1];
		if (/^\d+\.\d+\.\d+$/.test(lastSeg)) {
			segments = segments.slice(0, -1);
		}
	}
	let currentPath = '';
	for (let i = 0; i < segments.length; i++) {
		const seg = segments[i];
		currentPath += `/${seg}`;
		const isLast = i === segments.length - 1;
		const label = SEGMENT_LABELS[seg] ?? (isLast ? pageTitle!.split(/\s*[|\-â€“]\s*/)[0] : seg);
		crumbs.push({ name: label, path: `${currentPath}/` });
	}
}
---

{show && crumbs.length > 1 && (
	<div class="relative z-[15] w-full max-w-screen-xl mx-auto px-4 sm:px-8 pt-4">
		<nav aria-label="Fil d'Ariane" class="inline-flex rounded-lg border border-astro-dark-100/15 overflow-hidden">
			<ol class="flex items-stretch text-sm">
				{crumbs.map((crumb, i) => {
					const isFirst = i === 0;
					const isLast = i === crumbs.length - 1;
					const isLastWithoutVersion = isLast && pluginSlug && currentVersion;
					return (
						<li class="flex items-stretch">
							{!isFirst && (
								<svg class="h-full w-5 shrink-0 text-astro-dark-100/15" viewBox="0 0 24 44" preserveAspectRatio="none" fill="none" aria-hidden="true">
									<path d="M.293 0l22 22-22 22h1.414l22-22-22-22H.293z" fill="currentColor" />
								</svg>
							)}
							{isLastWithoutVersion ? (
								<span class="flex items-center px-4 py-2.5 text-astro-gray-200" aria-current="page">
									{crumb.name}
								</span>
							) : isLast ? (
								<span class="flex items-center px-4 py-2.5 text-astro-gray-200" aria-current="page">
									{isFirst ? (
										<svg class="size-4 shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
											<path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
										</svg>
									) : crumb.name}
								</span>
							) : (
								<a href={crumb.path} title={isFirst ? 'Accueil' : crumb.name} class="flex items-center px-4 py-2.5 text-astro-gray-400 hover:text-white transition-colors">
									{isFirst ? (
										<svg class="size-4 shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
											<path fill-rule="evenodd" d="M9.293 2.293a1 1 0 011.414 0l7 7A1 1 0 0117 11h-1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-3a1 1 0 00-1-1H9a1 1 0 00-1 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-6H3a1 1 0 01-.707-1.707l7-7z" clip-rule="evenodd" />
										</svg>
									) : crumb.name}
									{isFirst && <span class="sr-only">Accueil</span>}
								</a>
							)}
						</li>
					);
				})}
				{pluginSlug && currentVersion && (
					<li class="flex items-stretch">
						<svg class="h-full w-5 shrink-0 text-astro-dark-100/15" viewBox="0 0 24 44" preserveAspectRatio="none" fill="none" aria-hidden="true">
							<path d="M.293 0l22 22-22 22h1.414l22-22-22-22H.293z" fill="currentColor" />
						</svg>
						<span class="flex items-center pl-3 pr-1 py-1">
							<VersionSelector pluginSlug={pluginSlug} currentVersion={currentVersion} />
						</span>
					</li>
				)}
			</ol>
		</nav>
	</div>
)}
