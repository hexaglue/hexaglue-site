---
import { Icon } from 'astro-icon/components';
import { Code } from 'astro-expressive-code/components';
import { Image } from 'astro:assets';
import MainLayout from '~/layouts/MainLayout.astro';
import SectionCopy from '../_components/SectionCopy.astro';
import Link from '../_components/Link.astro';
import Insight from '~/components/Insight.astro';
import CompanionBanner from '~/components/CompanionBanner.astro';
import GreenishStardust from '../_components/landing-page/GreenishStardust.astro';
import codeJpaScreenshot from '~/assets/screenshots/code-jpa.png';

const domainCode = `// Pas d'annotation JPA, pas d'import infrastructure
public class Order {
    private OrderId id;
    private CustomerId customerId;
    private List<OrderLine> lines;
    private Money total;
    private OrderStatus status;

    public void addLine(Product product, int quantity) {
        // Logique métier uniquement
    }
}`;

const jpaCode = `@Entity
@Table(name = "orders")
public class OrderJpaEntity {
    @Id @GeneratedValue
    private Long id;

    @Column(name = "customer_id")
    private Long customerId;

    @OneToMany @JoinColumn(name = "order_id")
    private List<OrderLineJpaEntity> lines;

    @Embedded
    private MoneyEmbeddable total;

    @Enumerated(EnumType.STRING)
    private OrderStatus status;
}`;
---

<MainLayout
	title="Génération JPA"
	description="HexaGlue génère les entités JPA, repositories Spring Data, mappers MapStruct et adapters de ports depuis votre modèle de domaine. Zéro code manuel pour la couche persistance."
	schema={{
		"@type": "TechArticle",
		proficiencyLevel: "Beginner",
		about: [
			{ "@type": "Thing", name: "JPA" },
			{ "@type": "Thing", name: "Génération de code" },
			{ "@type": "Thing", name: "Architecture hexagonale" },
		],
	}}
>
	<!-- Hero Section -->
	<section class="pt-24 pb-16 md:pt-32 md:pb-20 relative w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<GreenishStardust height="h-64 md:h-80" />

		<div class="text-center max-w-3xl mx-auto">
			<span class="bg-clip-text text-transparent bg-blue-green-gradient font-semibold text-sm uppercase tracking-wider">
				Génération JPA
			</span>

			<h1 class="mt-4 font-heading heading-bold text-4xl md:text-5xl lg:text-6xl text-white text-balance">
				La persistance est du glue code.<br/>
				<span class="bg-clip-text text-transparent bg-blue-green-gradient">Pas besoin de l'écrire.</span>
			</h1>

			<p class="mt-6 text-lg text-astro-gray-200 font-light max-w-2xl mx-auto text-balance">
				HexaGlue génère les entités JPA, repositories Spring Data, mappers MapStruct et adapters de ports depuis votre modèle de domaine. Zéro code manuel pour la couche persistance.
			</p>
		</div>
	</section>

	<div class="relative z-[15] w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<CompanionBanner variant="features" href="/docs/plugin-jpa/" />
	</div>

	<!-- Section 1 : Ce qui est généré -->
	<section class="py-16 md:py-20 relative w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<SectionCopy
			label="Artefacts générés"
			title="5 types d'artefacts, synchronisés à chaque build"
		>
			À partir de votre modèle de domaine pur (sans annotations JPA), HexaGlue produit toute la couche persistance. Dans l'étude de cas e-commerce, cela représente 29 fichiers générés automatiquement.
		</SectionCopy>

		<div class="table-panel mt-10">
			<div class="table-panel-content max-w-4xl mx-auto overflow-x-auto">
				<table class="w-full text-sm text-left">
					<thead>
						<tr class="border-b border-astro-dark-100/20">
							<th class="py-3 pr-4 text-astro-gray-300 font-medium">Artefact</th>
							<th class="py-3 pr-4 text-astro-gray-300 font-medium">Quantité typique</th>
							<th class="py-3 text-astro-gray-300 font-medium">Rôle</th>
						</tr>
					</thead>
					<tbody class="text-astro-gray-200">
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Entités JPA</td>
							<td class="py-3 pr-4 whitespace-nowrap">1 par agrégat</td>
							<td class="py-3">Classes annotées <code>@Entity</code>, <code>@Table</code>, <code>@Column</code>, prêtes pour Hibernate</td>
						</tr>
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Embeddables</td>
							<td class="py-3 pr-4 whitespace-nowrap">1 par Value Object persisté</td>
							<td class="py-3"><code>@Embeddable</code> pour les VO stockés en colonnes (ex: <code>MoneyEmbeddable</code>)</td>
						</tr>
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Repositories Spring Data</td>
							<td class="py-3 pr-4 whitespace-nowrap">1 par agrégat</td>
							<td class="py-3">Interfaces <code>extends JpaRepository&lt;T, ID&gt;</code></td>
						</tr>
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Mappers MapStruct</td>
							<td class="py-3 pr-4 whitespace-nowrap">2 par agrégat (interface + impl)</td>
							<td class="py-3">Conversion bidirectionnelle domaine &#8596; JPA</td>
						</tr>
						<tr>
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Adapters de port</td>
							<td class="py-3 pr-4 whitespace-nowrap">1 par driven port Repository</td>
							<td class="py-3">Implémente le port défini dans le domaine, wrappe le repository Spring Data</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<div class="max-w-4xl mx-auto">
			<Insight variant="amber">
				<p>Le nombre d'artefacts générés croît linéairement avec la taille du domaine. Pour un domaine de 8 agrégats (étude de cas e-commerce), HexaGlue produit 29 fichiers. Pour un domaine de 20 agrégats, attendez environ 70 fichiers. C'est du code que vous n'avez pas à écrire ni à maintenir.</p>
			</Insight>
		</div>
	</section>

	<!-- Section 2 : Règles de mapping -->
	<section class="py-16 md:py-20 relative w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<SectionCopy
			label="Mapping"
			title="Comment le domaine se transforme en JPA"
		>
			HexaGlue analyse la classification de chaque type et applique des règles de transformation déterministes. Le tableau ci-dessous montre la correspondance entre les concepts du domaine et les artefacts JPA générés.
		</SectionCopy>

		<div class="table-panel mt-10">
			<div class="table-panel-content max-w-4xl mx-auto overflow-x-auto">
				<table class="w-full text-sm text-left">
					<thead>
						<tr class="border-b border-astro-dark-100/20">
							<th class="py-3 pr-4 text-astro-gray-300 font-medium">Concept domaine</th>
							<th class="py-3 pr-4 text-astro-gray-300 font-medium">Transformation</th>
							<th class="py-3 text-astro-gray-300 font-medium hidden md:table-cell">Exemple</th>
						</tr>
					</thead>
					<tbody class="text-astro-gray-200">
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Aggregate Root</td>
							<td class="py-3 pr-4"><code>@Entity</code> + <code>@Table</code> + Repository + Mapper + Adapter</td>
							<td class="py-3 hidden md:table-cell"><code>Order</code> → <code>OrderEntity</code>, <code>OrderJpaRepository</code>, <code>OrderMapper</code>, <code>OrderAdapter</code></td>
						</tr>
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Entity (enfant)</td>
							<td class="py-3 pr-4"><code>@Entity</code> lié à l'agrégat parent via <code>@JoinColumn</code></td>
							<td class="py-3 hidden md:table-cell"><code>OrderLine</code> → <code>OrderLineEntity</code></td>
						</tr>
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Value Object (multi-champs)</td>
							<td class="py-3 pr-4"><code>@Embeddable</code> avec tous les champs mappés</td>
							<td class="py-3 hidden md:table-cell"><code>Money(amount, currency)</code> → <code>MoneyEmbeddable</code></td>
						</tr>
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Value Object (mono-champ)</td>
							<td class="py-3 pr-4">Déplié vers le type primitif, pas d'embeddable</td>
							<td class="py-3 hidden md:table-cell"><code>record Quantity(int value)</code> → colonne <code>int</code></td>
						</tr>
						<tr class="border-b border-astro-dark-100/10">
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Identifier</td>
							<td class="py-3 pr-4">Déplié vers le type wrappé pour <code>@Id</code></td>
							<td class="py-3 hidden md:table-cell"><code>OrderId(UUID)</code> → <code>@Id UUID id</code></td>
						</tr>
						<tr>
							<td class="py-3 pr-4 font-medium text-white whitespace-nowrap">Driven Port (Repository)</td>
							<td class="py-3 pr-4">Interface <code>JpaRepository</code> + classe Adapter qui implémente le port</td>
							<td class="py-3 hidden md:table-cell"><code>OrderRepository</code> → <code>OrderJpaRepository</code> + <code>OrderAdapter</code></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<div class="max-w-4xl mx-auto">
			<Insight variant="green">
				<p>Ces règles sont déterministes : pour un même modèle de domaine, HexaGlue produit toujours le même code JPA. Pas de magie, pas de convention cachée. La classification du type détermine entièrement ce qui est généré.</p>
			</Insight>
		</div>
	</section>

	<!-- Section 3 : Avant / Après -->
	<section class="py-16 md:py-20 relative w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<SectionCopy
			label="Comparaison"
			title="Votre code vs le code généré"
		>
			Vous écrivez le domaine. HexaGlue génère l'infrastructure. Les deux sont synchronisés par construction.
		</SectionCopy>

		<div class="mt-10 max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-4">
			<Code code={domainCode} lang="java" title="Ce que vous écrivez : domaine pur" />
			<Code code={jpaCode} lang="java" title="Ce que HexaGlue génère : entité JPA" />
		</div>

		<div class="mt-10 max-w-4xl mx-auto">
			<Image
				src={codeJpaScreenshot}
				alt="Capture d'écran du code JPA généré par HexaGlue à partir du modèle de domaine"
				widths={[400, 600, 800, 1200]}
				sizes="(max-width: 1024px) 100vw, 800px"
				class="w-full rounded-xl border border-astro-dark-100/15 shadow-2xl"
				loading="lazy"
			/>
		</div>
	</section>

	<!-- Section 4 : Votre code -->
	<section class="py-16 md:py-20 relative w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<SectionCopy
			label="Ownership"
			title="Du code généré qui vous appartient"
		>
			Le code produit par HexaGlue n'est pas une boîte noire. Ce sont des classes Java standard, lisibles, débuggables. Vous choisissez comment les intégrer à votre projet.
		</SectionCopy>

		<div class="mt-10 max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
			<div class="p-5 bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-xl">
				<div class="flex items-center gap-3 mb-3">
					<div class="p-2 rounded-lg bg-blue-green-gradient/10 text-astro-green">
						<Icon name="ri:refresh-line" class="size-5" aria-hidden="true" />
					</div>
					<h3 class="text-white font-semibold">Régénérer à chaque build</h3>
				</div>
				<p class="text-sm text-astro-gray-200 font-light">Mode par défaut. Les artefacts sont écrits dans <code>target/</code> et régénérés à chaque <code>mvn compile</code>. Le code généré n'est pas versionné : il reste toujours synchronisé avec le domaine.</p>
			</div>

			<div class="p-5 bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-xl">
				<div class="flex items-center gap-3 mb-3">
					<div class="p-2 rounded-lg bg-blue-green-gradient/10 text-astro-green">
						<Icon name="ri:git-commit-line" class="size-5" aria-hidden="true" />
					</div>
					<h3 class="text-white font-semibold">Committer dans votre code</h3>
				</div>
				<p class="text-sm text-astro-gray-200 font-light">Redirigez la sortie vers <code>src/main/java</code> via l'option <code>outputDirectory</code>. Le code généré devient partie intégrante de votre projet. Vous pouvez ensuite le modifier, l'enrichir ou désactiver la régénération.</p>
			</div>
		</div>

		<div class="max-w-4xl mx-auto">
			<Insight variant="amber">
				<p>Sur l'étude de cas e-commerce (8 agrégats), le plugin génère 29 fichiers de persistance. C'est du code que vous n'écrivez pas, que vous ne maintenez pas, et qui reste synchronisé avec votre domaine par construction.</p>
			</Insight>
		</div>
	</section>

	<!-- Section 5 : Performance et compromis -->
	<section class="py-16 md:py-20 relative w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<SectionCopy
			label="Performance"
			title="Génération JPA vs SQL optimisé : un faux dilemme"
		>
			Une objection fréquente : le SQL écrit à la main est plus performant que le code JPA généré.
			C'est vrai. Mais les deux approches ne répondent pas au même problème.
		</SectionCopy>

		<div class="mt-10 max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4">
			<div class="p-5 bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-xl">
				<div class="flex items-center gap-3 mb-3">
					<div class="p-2 rounded-lg bg-blue-green-gradient/10 text-astro-green">
						<Icon name="ri:time-line" class="size-5" aria-hidden="true" />
					</div>
					<h3 class="text-white font-semibold">HexaGlue optimise le coût humain</h3>
				</div>
				<p class="text-sm text-astro-gray-200 font-light">Moins de code à écrire, moins de code à maintenir, moins de bugs de câblage. Pour la grande majorité des applications métier (CRUD, back-office, SaaS, SI internes), les performances JPA standard sont largement suffisantes.</p>
			</div>

			<div class="p-5 bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-xl">
				<div class="flex items-center gap-3 mb-3">
					<div class="p-2 rounded-lg bg-blue-green-gradient/10 text-astro-green">
						<Icon name="ri:speed-line" class="size-5" aria-hidden="true" />
					</div>
					<h3 class="text-white font-semibold">Le SQL manuel optimise le coût machine</h3>
				</div>
				<p class="text-sm text-astro-gray-200 font-light">Requêtes taillées pour le plan d'exécution, exploitation fine des index, contrôle total sur les jointures. Indispensable pour les chemins critiques à forte charge (trading, analytics, temps réel).</p>
			</div>
		</div>

		<div class="max-w-4xl mx-auto">
			<Insight variant="green">
				<p>Les deux approches coexistent dans les architectures matures. HexaGlue couvre les 80 à 90 % de cas CRUD standard où la productivité prime sur la micro-optimisation.<br>
				Pour les requêtes critiques, Spring Data JPA offre <code>@Query</code> (JPQL), requêtes natives et projections : vous gardez le contrôle là où il compte, sans renoncer à l'automatisation partout ailleurs.</p>
			</Insight>
		</div>
	</section>

	<!-- CTA Final -->
	<section class="py-16 md:py-24 mb-12 relative">
		<div class="w-full max-w-screen-xl mx-auto px-4 sm:px-8 text-center space-y-6">
			<h2 class="font-heading heading-bold text-3xl md:text-4xl lg:text-5xl text-white">
				<span class="text-astro-gray-300">Votre métier mérite toute votre attention.</span><br/>
				Générez la persistance en un build.
			</h2>

			<p class="text-xl text-astro-gray-200 font-light max-w-2xl mx-auto">
				Voyez comment HexaGlue produit 29 fichiers de persistance à partir d'un domaine pur.
			</p>

			<div class="pt-4 flex flex-col sm:flex-row items-center justify-center gap-4">
				<Link href="/case-studies/ecommerce-migration/step-5-generated/" class="primary">
					Voir la génération en action
				</Link>
				<Link href="/docs/plugin-jpa/" class="secondary">
					<Icon name="ri:settings-3-line" class="size-5" aria-hidden="true" />
					<span>Configurer le plugin JPA</span>
				</Link>
			</div>
		</div>
		<div
			class="absolute inset-x-0 bottom-0 h-[50vw] translate-y-[60%] bg-blue-green-gradient opacity-50 mask-radial-gradient pointer-events-none"
		></div>
	</section>
</MainLayout>

<style>
	code {
		@apply px-1.5 py-0.5 bg-astro-dark-600 rounded text-xs text-astro-gray-100;
		font-family: 'JetBrains Mono', ui-monospace, monospace;
	}
	.table-panel {
		position: relative;
		left: 50%;
		margin-left: -50vw;
		width: 100vw;
		padding: 2.5rem 1rem;
		border-top: 1px solid rgba(56, 189, 126, 0.07);
		border-bottom: 1px solid rgba(56, 189, 126, 0.07);
		background:
			radial-gradient(circle at 1px 1px, rgba(56, 189, 126, 0.12) 1px, transparent 0) 0 0 / 24px 24px,
			linear-gradient(180deg, rgba(56, 189, 126, 0.04) 0%, rgba(56, 189, 126, 0.02) 50%, rgba(56, 189, 126, 0.04) 100%);
	}
	.table-panel-content {
		background-color: #0e0d12;
		border: 1px solid rgba(56, 189, 126, 0.1);
		border-radius: 0.75rem;
		padding: 1.5rem;
		box-shadow:
			0 0 20px rgba(56, 189, 126, 0.12),
			0 0 50px rgba(56, 189, 126, 0.07),
			0 0 80px rgba(56, 189, 126, 0.04),
			0 1px 2px rgba(0, 0, 0, 0.4),
			0 4px 16px rgba(0, 0, 0, 0.3);
	}
</style>
