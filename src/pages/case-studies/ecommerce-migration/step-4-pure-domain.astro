---
import MainLayout from '~/layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
import { Code } from 'astro-expressive-code/components';

import StepNavigation from './_components/StepNavigation.astro';
import AuditReport from './_components/AuditReport.astro';
import AuditVerdict from './_components/AuditVerdict.astro';
import KpiTable, { type KpiRow } from './_components/KpiTable.astro';
import ViolationsTable, { type ViolationRow } from './_components/ViolationsTable.astro';
import MetricsTable from './_components/MetricsTable.astro';
import InventoryTable, { type InventoryRow } from './_components/InventoryTable.astro';
import PackageStabilityTable, { type PackageStabilityRow } from './_components/PackageStabilityTable.astro';
import RemediationTable, { type RemediationRow } from './_components/RemediationTable.astro';
import SectionCopy from '../../_components/SectionCopy.astro';
import AmberStardust from '../../_components/landing-page/AmberStardust.astro';
import Insight from '~/components/Insight.astro';
import ModificationList from './_components/ModificationList.astro';
import ModificationGroup from './_components/ModificationGroup.astro';
import ModificationItem from './_components/ModificationItem.astro';

// Code examples
const beforeIdentifier = `// Dans Order.java (via BaseEntity)
@MappedSuperclass
public abstract class BaseEntity {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
}`;

const afterIdentifier = `public record OrderId(Long value) {
    public OrderId {
        if (value == null) {
            throw new IllegalArgumentException("OrderId value must not be null");
        }
    }
}`;

const beforeEntity = `@Entity
@Table(name = "orders")
public class Order extends BaseEntity {
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "customer_id")
    private Customer customer;

    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderLine> lines = new ArrayList<>();

    @Column(precision = 10, scale = 2)
    private BigDecimal totalAmount;
    // getters, setters...
}`;

const afterEntity = `public class Order {
    private OrderId id;
    private final String orderNumber;
    private final CustomerId customerId;
    private final List<OrderLine> lines = new ArrayList<>();
    private OrderStatus status;
    private Money totalAmount;
    private Address shippingAddress;

    public static Order create(String orderNumber, CustomerId customerId, String currency) {
        return new Order(null, orderNumber, customerId, OrderStatus.DRAFT,
                Money.zero(currency), null, null, null, null, null, null, null, null);
    }

    public OrderPlacedEvent place(Address shippingAddress) {
        if (status != OrderStatus.DRAFT) {
            throw new IllegalStateException("Order can only be placed from DRAFT status");
        }
        this.shippingAddress = shippingAddress;
        this.status = OrderStatus.PLACED;
        this.placedAt = LocalDateTime.now();
        return OrderPlacedEvent.now(id, customerId, totalAmount);
    }
    // markPaid(), ship(), deliver(), cancel()...
}`;

const valueObject = `public record Money(BigDecimal amount, String currency) {
    public Money {
        if (amount == null) throw new IllegalArgumentException("Amount must not be null");
        amount = amount.setScale(2, RoundingMode.HALF_UP);
    }

    public static Money of(BigDecimal amount, String currency) {
        return new Money(amount, currency);
    }

    public Money add(Money other) {
        requireSameCurrency(other);
        return new Money(this.amount.add(other.amount), this.currency);
    }

    public Money multiply(int quantity) {
        return new Money(this.amount.multiply(BigDecimal.valueOf(quantity)), this.currency);
    }
}`;

const domainEvent = `public record OrderPlacedEvent(
        OrderId orderId,
        CustomerId customerId,
        Money totalAmount,
        Instant occurredAt) {

    public static OrderPlacedEvent now(OrderId orderId, CustomerId customerId, Money totalAmount) {
        return new OrderPlacedEvent(orderId, customerId, totalAmount, Instant.now());
    }
}`;

const kpiRows: KpiRow[] = [
    { dimension: 'DDD Compliance', value: '100%', weight: '25%', contribution: '25.0', threshold: '≥ 90%', status: 'OK', delta: '+100' },
    { dimension: 'Hexagonal Architecture', value: '35%', weight: '25%', contribution: '8.8', threshold: '≥ 90%', status: 'CRITICAL', delta: '-65' },
    { dimension: 'Dependencies', value: '0%', weight: '20%', contribution: '0.0', threshold: '≥ 80%', status: 'CRITICAL', delta: '=' },
    { dimension: 'Coupling', value: '31%', weight: '15%', contribution: '4.7', threshold: '≥ 70%', status: 'CRITICAL', delta: '-6' },
    { dimension: 'Cohesion', value: '71%', weight: '15%', contribution: '10.7', threshold: '≥ 80%', status: 'WARNING', delta: '+7' },
];

const inventoryRows: InventoryRow[] = [
    { component: 'Aggregate Roots', count: 6, delta: '+6', observation: 'Customer, Order, Product, Inventory, Payment, Shipment' },
    { component: 'Entities', count: 2, delta: '-7', observation: 'OrderLine, StockMovement' },
    { component: 'Value Objects', count: 7, delta: '+4', observation: 'Money, Address, Email, Quantity + 3 enums' },
    { component: 'Identifiers', count: 6, delta: '+6', observation: 'OrderId, CustomerId, ProductId, PaymentId, ShipmentId, InventoryId' },
    { component: 'Domain Events', count: 1, delta: '+1', observation: 'OrderPlacedEvent' },
    { component: 'Driving Ports', count: 6, delta: '=', observation: '' },
    { component: 'Driven Ports', count: 9, delta: '=', observation: '' },
    { component: 'Application Services', count: 7, delta: '+7', observation: 'Classifiés APPLICATION_SERVICE' },
];

const violationRows: ViolationRow[] = [
    { constraint: 'ddd:entity-identity', count: 0, severity: 'CRITICAL', delta: '-9', observation: 'Identifiants typés créés' },
    { constraint: 'ddd:domain-purity', count: 0, severity: 'CRITICAL', delta: '-9', observation: 'Annotations JPA supprimées' },
    { constraint: 'hexagonal:port-coverage', count: 6, severity: 'MAJOR', delta: '+6', observation: 'Repos JPA supprimés, ports sans adaptateur' },
    { constraint: 'hexagonal:application-purity', count: 7, severity: 'MAJOR', delta: '+7', observation: '7 services avec imports Spring' },
];

// Metrics data with deltas
const metricsData = [
  {
    metric: 'Domain purity',
    value: '100.00%',
    threshold: 'min 100%',
    status: 'OK' as const,
    delta: '+75.00',
  },
  {
    metric: 'Aggregate boundary',
    value: '100.00%',
    threshold: 'min 80%',
    status: 'OK' as const,
    delta: '+100.00',
  },
  {
    metric: 'Code boilerplate',
    value: '80.20%',
    threshold: 'max 50%',
    status: 'CRITICAL' as const,
    delta: '-19.80',
  },
  {
    metric: 'Aggregate avg size',
    value: '14.33',
    threshold: 'max 20',
    status: 'OK' as const,
    delta: '+14.33',
  },
  {
    metric: 'Domain coverage',
    value: '50.00%',
    threshold: 'min 30%',
    status: 'OK' as const,
    delta: '+5.56',
  },
  {
    metric: 'Classification rate',
    value: '95.7%',
    threshold: 'min 80%',
    status: 'OK' as const,
    delta: '+13.9',
  },
];

// Package stability data (selected)
const packageStabilityRows: PackageStabilityRow[] = [
    { package: 'domain.order', ca: 23, ce: 2, instability: 0.08, abstractness: 0.00, distance: 0.92, zone: 'Zone of Pain' },
    { package: 'application', ca: 0, ce: 28, instability: 1.00, abstractness: 0.00, distance: 0.00, zone: 'Main Sequence' },
];

const remediationRows: RemediationRow[] = [
    {
        constraint: 'ddd:entity-identity',
        violations: 0,
        severity: 'CRITICAL',
        manualEffort: 0,
        hexaglueEffort: 0,
        description: 'Identifiants typés créés',
    },
    {
        constraint: 'ddd:domain-purity',
        violations: 0,
        severity: 'CRITICAL',
        manualEffort: 0,
        hexaglueEffort: 0,
        description: 'Domaine purifié',
    },
    {
        constraint: 'hexagonal:port-coverage',
        violations: 6,
        severity: 'MAJOR',
        manualEffort: 18,
        hexaglueEffort: 0,
        description: 'Ports driven sans adaptateur (génération HexaGlue)',
    },
    {
        constraint: 'hexagonal:application-purity',
        violations: 7,
        severity: 'MAJOR',
        manualEffort: 7,
        hexaglueEffort: 7,
        description: 'Services applicatifs avec @Service/@Transactional',
    },
];
---

<MainLayout
  title="Étape 4 - Purification du domaine | HexaGlue"
  description="Purification du domaine : suppression des annotations JPA, création de 6 identifiants typés et 7 value objects. Patterns DDD en place, score 49/100."
>
  <!-- Hero Section -->
  <section class="pt-24 pb-16 md:pt-32 md:pb-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <AmberStardust height="h-64 md:h-80" />
    <div class="max-w-5xl mx-auto">
      <div class="mt-8 max-w-3xl">
        <span class="bg-clip-text text-transparent bg-orange-yellow-gradient font-semibold text-sm uppercase tracking-wider">
          Étape 4
        </span>
        <h1 class="mt-4 font-heading heading-bold text-4xl md:text-5xl lg:text-6xl text-white text-balance">
          Purification du domaine
        </h1>
        <a
          href="https://github.com/hexaglue/case-study-ecommerce/tree/step/4-pure-domain"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-4 px-4 py-2 group inline-flex items-center justify-center gap-2 rounded-full border border-astro-dark-100/30 hover:border-astro-dark-100/60 text-base font-normal text-astro-gray-200 hover:text-astro-gray-100 bg-astro-dark-600/30 transition-all ease-in-out duration-500"
        >
          <Icon name="logos/github" class="size-5" aria-hidden="true" />
          <code class="text-sm text-amber-400">step/4-pure-domain</code>
        </a>
        <ul class="mt-6 text-lg text-astro-gray-200 font-light max-w-2xl space-y-1 list-disc list-inside">
          <li>Domaine pur sans annotations JPA.</li>
          <li>Value objects et identifiants typés (records).</li>
          <li>Logique métier dans les agrégats.</li>
          <li>18 violations CRITICAL résolues.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Modifications effectuées -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Modifications"
        title="Modifications effectuées"
        gradient="bg-orange-yellow-gradient"
      >
        Le domaine est purifié : toutes les annotations JPA sont supprimées et remplacées par des patterns tactiques DDD (identifiants typés, value objects, agrégats avec logique métier).
        Les adaptateurs JPA de persistance sont également supprimés, puisque le domaine qu'ils mappaient n'existe plus sous cette forme.
      </SectionCopy>

      <ModificationList class="mt-10">
        <ModificationGroup layer="domain">
          <ModificationItem action="create" count={6} label="identifiants typés" details="OrderId, CustomerId, ProductId, PaymentId, ShipmentId, InventoryId" />
          <ModificationItem action="create" count={4} label="value objects" details="Money, Address, Email, Quantity" />
          <ModificationItem action="create" count={1} label="domain event" details="OrderPlacedEvent" />
          <ModificationItem action="purify" count={9} label="classes domaine" details="suppression @Entity, @ManyToOne, extends BaseEntity" />
          <ModificationItem action="remove" label="BaseEntity" details="chaque agrégat définit son propre identifiant typé" />
        </ModificationGroup>
        <ModificationGroup layer="adapters">
          <ModificationItem action="remove" count={6} label="repositories JPA" details="JpaOrderRepository, JpaCustomerRepository, etc." />
        </ModificationGroup>
        <ModificationGroup layer="configuration">
          <ModificationItem action="configure" label="hexaglue.yaml" details="com.acme.shop.infrastructure.** est retiré des exclusions" />
        </ModificationGroup>
      </ModificationList>

      <Insight>
        <p>C'est la transformation fondamentale du DDD : séparer le modèle métier de l'infrastructure.</p>
        <ul>
          <li><strong>Identifiants typés</strong> (records) : remplacent les <code>Long</code> génériques, chaque agrégat a son propre type d'identifiant</li>
          <li><strong>Value objects</strong> : encapsulent les règles de validation et le comportement (ex. <code>Money</code> sait additionner et multiplier)</li>
          <li><strong>Agrégats</strong> : protègent leurs invariants via des méthodes métier (<code>place()</code>, <code>cancel()</code>...)</li>
          <li><strong>Repositories JPA supprimés</strong> : le domaine purifié n'est plus compatible avec les anciens adaptateurs, ils seront régénérés par HexaGlue</li>
        </ul>
        <p>Le retrait de <code>com.acme.shop.infrastructure.**</code> des exclusions permet à HexaGlue d'analyser les services applicatifs. Puisqu'ils implémentent des driving ports, ils sont correctement classifiés comme APPLICATION_SERVICE.</p>
      </Insight>
    </div>
  </section>

  <!-- Code Examples: Identifiers -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Code"
        title="Identifiants typés"
        gradient="bg-orange-yellow-gradient"
      >
        Transformation des identifiants <code>Long</code> en <code>record</code> immuables avec validation.
      </SectionCopy>

      <div class="mt-10 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <Code code={beforeIdentifier} lang="java" title="AVANT - OrderId (Long)" />
        </div>
        <div>
          <Code code={afterIdentifier} lang="java" title="APRÈS - OrderId (record)" />
        </div>
      </div>

      <Insight>
        <ul>
          <li>Le <strong>record</strong> remplace le <code>Long</code> générique : on ne peut plus confondre un <code>OrderId</code> avec un <code>CustomerId</code></li>
          <li>La <strong>validation</strong> au constructeur garantit qu'aucun identifiant nul ne circule dans le domaine</li>
          <li>HexaGlue détecte automatiquement ce pattern et classifie le type comme <strong>IDENTIFIER</strong></li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Code Examples: Domain Entity -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Code"
        title="Agrégat purifié"
        gradient="bg-orange-yellow-gradient"
      >
        Transformation de l'entité <code>@Entity</code> JPA en agrégat DDD avec logique métier.
      </SectionCopy>

      <div class="mt-10 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <Code code={beforeEntity} lang="java" title="AVANT - Order.java (avec JPA)" />
        </div>
        <div>
          <Code code={afterEntity} lang="java" title="APRÈS - Order.java (purifié)" />
        </div>
      </div>

      <Insight>
        <ul>
          <li><strong>Identifiants typés</strong> : <code>CustomerId</code> au lieu de la référence directe à <code>Customer</code>, ce qui découple les agrégats entre eux</li>
          <li><strong>Value objects</strong> : <code>Money</code> et <code>Address</code> encapsulent des concepts métier avec leur propre validation</li>
          <li><strong>Logique métier</strong> : les méthodes <code>place()</code>, <code>markPaid()</code> protègent les invariants de l'agrégat</li>
          <li><strong>Annotations JPA supprimées</strong> : le mapping de persistance sera généré par HexaGlue à l'étape 5</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Code Examples: Value Object & Domain Event -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Code"
        title="Value Objects & Domain Events"
        gradient="bg-orange-yellow-gradient"
      >
        Les value objects et domain events sont implémentés en records Java : immuables, avec validation intégrée et comportement métier.
      </SectionCopy>

      <div class="mt-10 space-y-4">
        <Code code={valueObject} lang="java" title="Money.java - Value Object" />
        <Code code={domainEvent} lang="java" title="OrderPlacedEvent.java" />
      </div>

      <Insight>
        <ul>
          <li><strong>Value objects</strong> : <code>Money</code> encapsule les opérations monétaires (addition, multiplication) et valide ses invariants à la construction</li>
          <li><strong>Domain events</strong> : <code>OrderPlacedEvent</code> capture un fait métier significatif avec toutes les informations nécessaires à son traitement</li>
        </ul>
        <p>HexaGlue détecte automatiquement ces patterns et les classifie comme VALUE_OBJECT et DOMAIN_EVENT.</p>
      </Insight>
    </div>
  </section>

  <AuditReport description="Résultat après purification du domaine et création des patterns tactiques DDD.">

  <!-- Audit Verdict -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Verdict"
        title="Verdict de l'audit"
        gradient="bg-orange-yellow-gradient"
      >
        Le verdict passe au statut <strong>PASSED_WITH_WARNINGS</strong> : toutes les violations critiques sont résolues, il ne reste que des violations majeures.
      </SectionCopy>

      <div class="mt-10">
        <AuditVerdict
        score={49}
        grade="F"
        status="PASSED_WITH_WARNINGS"
        violations={{
          critical: 0,
          major: 13,
        }}
          delta={{
            score: 9,
            violations: -5,
          }}
        />
      </div>

      <Insight>
        <p>C'est un tournant dans la migration : les 18 violations CRITICAL ont toutes disparu. Le score progresse de 9 points et l'audit passe au statut PASSED_WITH_WARNINGS. Les 13 violations MAJOR restantes seront détaillées dans les sections suivantes.</p>
      </Insight>
    </div>
  </section>

  <!-- KPI Table -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Score"
        title="Décomposition du score"
        gradient="bg-orange-yellow-gradient"
      >
        Le score passe de 40 à 49/100. La dimension DDD atteint 100%, mais la dimension hexagonale recule temporairement.
      </SectionCopy>

      <div class="mt-10">
        <KpiTable rows={kpiRows} total="49.2" />
      </div>

      <Insight>
        <ul>
          <li><strong>DDD Compliance</strong> à 100% (+100) : HexaGlue détecte les identifiants typés, value objects, agrégats et domain events</li>
          <li><strong>Hexagonal Architecture</strong> chute à 35% (-65) : la suppression des repositories JPA laisse 6 driven ports sans adaptateur</li>
          <li><strong>Cohesion</strong> progresse à 71% (+7) : les agrégats regroupent des concepts cohérents avec leur logique métier</li>
        </ul>
        <p>La chute de la dimension hexagonale est temporaire : les adaptateurs seront générés à l'étape suivante.</p>
      </Insight>
    </div>
  </section>

  <!-- Inventory Table -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Inventaire"
        title="Inventaire architectural"
        gradient="bg-orange-yellow-gradient"
      >
        L'inventaire est transformé : les entités JPA ont cédé la place aux patterns tactiques DDD.
        Les services applicatifs apparaissent maintenant qu'ils ne sont plus exclus du périmètre.
      </SectionCopy>

      <div class="mt-10">
        <InventoryTable rows={inventoryRows} />
      </div>

      <Insight>
        <ul>
          <li><strong>6 aggregate roots</strong> détectés : grâce aux identifiants typés, HexaGlue promeut les entités en agrégats</li>
          <li><strong>9 entities &rarr; 6 agrégats + 2 entités internes</strong> : <code>OrderLine</code> et <code>StockMovement</code> restent des entités internes à leur agrégat</li>
          <li><strong>7 application services</strong> classifiés : ils implémentent des driving ports, HexaGlue les reconnaît comme APPLICATION_SERVICE</li>
          <li><strong>6 identifiants + 7 value objects + 1 domain event</strong> : le modèle DDD est complet</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Violations Table -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Violations"
        title="Violations détectées"
        gradient="bg-orange-yellow-gradient"
      >
        Les violations DDD sont entièrement résolues. En contrepartie, de nouvelles violations hexagonales apparaissent suite à la suppression des repositories JPA.
      </SectionCopy>

      <div class="mt-10">
        <ViolationsTable rows={violationRows} />
      </div>

      <Insight>
        <ul>
          <li><strong>entity-identity</strong> et <strong>domain-purity</strong> à 0 : les identifiants typés et la suppression des annotations JPA résolvent les 18 violations CRITICAL</li>
          <li><strong>port-coverage</strong> (+6) : les repositories JPA ont été supprimés avec les annotations, les driven ports n'ont plus d'implémentation</li>
          <li><strong>application-purity</strong> (+7) : les services applicatifs utilisent encore <code>@Service</code> et <code>@Transactional</code> de Spring</li>
        </ul>
        <p>Les adaptateurs JPA seront régénérés automatiquement par HexaGlue à l'étape suivante.</p>
      </Insight>
    </div>
  </section>

  <!-- Metrics Table -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Qualité"
        title="Métriques de qualité"
        gradient="bg-orange-yellow-gradient"
      >
        Les métriques de qualité reflètent la transformation du domaine. Les indicateurs DDD passent au vert.
      </SectionCopy>

      <div class="mt-10">
        <MetricsTable rows={metricsData} />
      </div>

      <Insight>
        <ul>
          <li><strong>Domain purity</strong> à 100% : aucun import d'infrastructure dans le domaine, c'est l'objectif fondamental de la purification</li>
          <li><strong>Aggregate boundary</strong> à 100% : chaque agrégat a son identifiant typé et ses frontières de cohérence</li>
          <li><strong>Classification rate</strong> à 95,7% : quasi toutes les classes ont un rôle architectural identifié</li>
          <li><strong>Boilerplate</strong> reste à 80% : les getters sont conservés, mais le domaine contient maintenant de la logique métier</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Remediation -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Remédiation"
        title="Coût de mise en conformité"
        gradient="bg-orange-yellow-gradient"
      >
        Le tableau de remédiation montre que les contraintes DDD sont résolues. L'effort restant concerne la couche hexagonale et les annotations Spring.
      </SectionCopy>

      <div class="mt-10">
        <RemediationTable rows={remediationRows} />
      </div>

      <Insight>
        <ul>
          <li><strong>entity-identity</strong> et <strong>domain-purity</strong> à 0 : plus aucun effort nécessaire sur le domaine</li>
          <li><strong>port-coverage</strong> (18j) : entièrement automatisable par le plugin JPA de HexaGlue, qui génèrera les entités JPA, mappers et repositories</li>
          <li><strong>application-purity</strong> (7j) : déplacement des annotations <code>@Service</code> et <code>@Transactional</code> vers la couche infrastructure</li>
        </ul>
        <p>Au total : 25 jours manuels réduits à 7 jours avec HexaGlue (72% d'économie).</p>
      </Insight>
    </div>
  </section>

  <!-- Package Stability -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Stabilité"
        title="Stabilité des packages"
        gradient="bg-orange-yellow-gradient"
      >
        L'analyse de stabilité montre comment la purification du domaine a modifié les dépendances entre packages.
      </SectionCopy>

      <div class="mt-10">
        <PackageStabilityTable rows={packageStabilityRows} />
      </div>

      <Insight>
        <ul>
          <li><strong>domain.order</strong> en Zone of Pain (D=0.92) : ce package est très sollicité (23 dépendants) et concret, ce qui est attendu pour un core domain riche en logique métier</li>
          <li><strong>application</strong> sur la Main Sequence : parfaitement instable (I=1.00), les services applicatifs dépendent de tout mais personne ne dépend d'eux</li>
        </ul>
      </Insight>
    </div>
  </section>

  </AuditReport>

  <!-- Bilan Section -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Bilan"
        title="Ce que révèle cette étape"
        gradient="bg-orange-yellow-gradient"
      >
        Le domaine est purifié et tous les patterns tactiques DDD sont en place.
        Le code métier est maintenant indépendant de toute technologie d'infrastructure.
      </SectionCopy>

      <Insight class="mt-10">
        <p>Les constats principaux :</p>
        <ul>
          <li><strong>Score 49/100 (+9)</strong> : passage au statut PASSED_WITH_WARNINGS, les 18 violations CRITICAL sont résolues</li>
          <li><strong>DDD Compliance à 100%</strong> : identifiants typés, value objects, agrégats avec logique métier, domain events</li>
          <li><strong>Domain purity à 100%</strong> : zéro import JPA dans le domaine, le code métier est testable sans infrastructure</li>
          <li><strong>13 violations MAJOR</strong> restantes : 6 driven ports sans adaptateur et 7 services avec annotations Spring</li>
          <li><strong>72% d'économie</strong> : 25 jours manuels réduits à 7 jours grâce à la génération automatique</li>
        </ul>
        <p>L'étape suivante active la génération automatique de HexaGlue pour recréer toute la couche d'infrastructure.</p>
      </Insight>
    </div>
  </section>

  <!-- Navigation -->
  <section class="py-16 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <StepNavigation
        prev={{
          href: '/case-studies/ecommerce-migration/step-3-hexagonal/',
          label: 'Étape 3 - Réorganisation en couches hexagonales'
        }}
        next={{
          href: '/case-studies/ecommerce-migration/step-5-generated/',
          label: 'Étape 5 - Génération automatique de l\'infrastructure'
        }}
      />
    </div>
  </section>
</MainLayout>
