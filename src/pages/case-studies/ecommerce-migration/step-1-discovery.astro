---
import MainLayout from '~/layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
import { Code } from 'astro-expressive-code/components';
import StepNavigation from '../_components/StepNavigation.astro';
import AuditReport from '../_components/AuditReport.astro';
import AuditVerdict from '../_components/AuditVerdict.astro';
import KpiTable, { type KpiRow } from '../_components/KpiTable.astro';
import ViolationsTable, { type ViolationRow } from '../_components/ViolationsTable.astro';
import MetricsTable, { type MetricRow } from '../_components/MetricsTable.astro';
import InventoryTable, { type InventoryRow } from '../_components/InventoryTable.astro';
import PackageStabilityTable, { type PackageStabilityRow } from '../_components/PackageStabilityTable.astro';
import RemediationTable, { type RemediationRow } from '../_components/RemediationTable.astro';
import SectionCopy from '../../_components/SectionCopy.astro';
import AmberStardust from '../../_components/landing-page/AmberStardust.astro';
import Insight from '~/components/Insight.astro';

const pomXmlConfig = `<plugin>
    <groupId>io.hexaglue</groupId>
    <artifactId>hexaglue-maven-plugin</artifactId>
    <version>5.0.0</version>
    <extensions>true</extensions>
    <configuration>
        <basePackage>com.acme.shop</basePackage>
        <failOnError>false</failOnError>
    </configuration>
    <dependencies>
        <dependency>
            <groupId>io.hexaglue.plugins</groupId>
            <artifactId>hexaglue-plugin-audit</artifactId>
            <version>2.0.0</version>
        </dependency>
    </dependencies>
</plugin>`;

const kpiRows: KpiRow[] = [
    { dimension: 'DDD Compliance', value: '0%', weight: '25%', contribution: '0.0', threshold: '≥ 90%', status: 'CRITICAL', delta: '-' },
    { dimension: 'Hexagonal Architecture', value: '0%', weight: '25%', contribution: '0.0', threshold: '≥ 90%', status: 'CRITICAL', delta: '-' },
    { dimension: 'Dependencies', value: '0%', weight: '20%', contribution: '0.0', threshold: '≥ 80%', status: 'CRITICAL', delta: '-' },
    { dimension: 'Coupling', value: '30%', weight: '15%', contribution: '4.5', threshold: '≥ 70%', status: 'CRITICAL', delta: '-' },
    { dimension: 'Cohesion', value: '58%', weight: '15%', contribution: '8.7', threshold: '≥ 80%', status: 'CRITICAL', delta: '-' },
];

const inventoryRows: InventoryRow[] = [
    { component: 'Aggregate Roots', count: 0, delta: '-', observation: 'Aucun détecté' },
    { component: 'Entities', count: 9, delta: '-', observation: 'Tous les @Entity JPA' },
    { component: 'Value Objects', count: 14, delta: '-', observation: '3 enums + 8 services + 3 DTOs (faux positifs)' },
    { component: 'Identifiers', count: 0, delta: '-', observation: '' },
    { component: 'Domain Events', count: 1, delta: '-', observation: 'Spring ApplicationEvent (faux positif)' },
    { component: 'Driving Ports', count: 0, delta: '-', observation: '' },
    { component: 'Driven Ports', count: 6, delta: '-', observation: 'Les 6 repositories Spring Data' },
];

const violationRows: ViolationRow[] = [
    { constraint: 'ddd:domain-purity', count: 10, severity: 'CRITICAL', delta: '-', observation: '9 modèles + OrderService avec imports JPA' },
    { constraint: 'ddd:entity-identity', count: 9, severity: 'CRITICAL', delta: '-', observation: '9 entités sans champ identité typé' },
    { constraint: 'hexagonal:layer-isolation', count: 12, severity: 'MAJOR', delta: '-', observation: '7 services dépendent des repositories' },
    { constraint: 'hexagonal:port-direction', count: 6, severity: 'MAJOR', delta: '-', observation: '6 driven ports non utilisés par un service applicatif' },
    { constraint: 'hexagonal:port-coverage', count: 6, severity: 'MAJOR', delta: '-', observation: '6 driven ports sans adaptateur d\'infrastructure' },
];

const metricRows: MetricRow[] = [
    { metric: 'Domain coverage', value: '80.00%', threshold: 'min 30%', status: 'OK', delta: '-' },
    { metric: 'Code boilerplate', value: '81.58%', threshold: 'max 50%', status: 'CRITICAL', delta: '-' },
    { metric: 'Domain purity', value: '58.33%', threshold: 'min 100%', status: 'CRITICAL', delta: '-' },
    { metric: 'Aggregate boundary', value: '0.00%', threshold: 'min 80%', status: 'CRITICAL', delta: '-' },
    { metric: 'Code complexity', value: '1.11', threshold: 'max 10', status: 'OK', delta: '-' },
];

const packageStabilityRows: PackageStabilityRow[] = [
    { package: 'shop.model', ca: 18, ce: 0, instability: 0.00, abstractness: 0.08, distance: 0.92, zone: 'Zone of Pain' },
    { package: 'shop.dto', ca: 5, ce: 1, instability: 0.17, abstractness: 0.00, distance: 0.83, zone: 'Zone of Pain' },
    { package: 'shop.service', ca: 5, ce: 18, instability: 0.78, abstractness: 0.00, distance: 0.22, zone: 'Stable Core' },
    { package: 'shop.repository', ca: 7, ce: 9, instability: 0.56, abstractness: 1.00, distance: 0.56, zone: 'Main Sequence' },
    { package: 'shop.controller', ca: 0, ce: 15, instability: 1.00, abstractness: 0.00, distance: 0.00, zone: 'Main Sequence' },
];

const remediationRows: RemediationRow[] = [
    {
        constraint: 'ddd:entity-identity',
        violations: 9,
        severity: 'CRITICAL',
        manualEffort: 4,
        hexaglueEffort: 4,
        description: 'Entités sans identifiant typé',
    },
    {
        constraint: 'ddd:domain-purity',
        violations: 10,
        severity: 'CRITICAL',
        manualEffort: 15,
        hexaglueEffort: 15,
        description: 'Annotations JPA dans le domaine',
    },
    {
        constraint: 'hexagonal:port-coverage',
        violations: 6,
        severity: 'MAJOR',
        manualEffort: 18,
        hexaglueEffort: 0,
        description: 'Ports sans adaptateur (repositories Spring Data)',
    },
    {
        constraint: 'hexagonal:layer-isolation',
        violations: 12,
        severity: 'MAJOR',
        manualEffort: 6,
        hexaglueEffort: 6,
        description: 'Services dépendant des repositories',
    },
    {
        constraint: 'hexagonal:port-direction',
        violations: 6,
        severity: 'MAJOR',
        manualEffort: 1.5,
        hexaglueEffort: 1.5,
        description: 'Ports appelés dans la mauvaise direction',
    },
];
---

<MainLayout
    title="Étape 1 - Premier diagnostic avec HexaGlue | Migration E-Commerce"
    description="Premier audit HexaGlue sur une application legacy Spring Boot. Score 13/100, 43 violations détectées dont 19 critiques. Diagnostic complet et quantifié."
>
    <!-- Hero Section -->
    <section class="pt-24 pb-16 md:pt-32 md:pb-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <AmberStardust height="h-64 md:h-80" />
        <div class="max-w-5xl mx-auto">
            <div class="mt-8 max-w-3xl">
                <span class="bg-clip-text text-transparent bg-orange-yellow-gradient font-semibold text-sm uppercase tracking-wider">
                    Étape 1
                </span>
                <h1 class="mt-4 font-heading heading-bold text-4xl md:text-5xl lg:text-6xl text-white text-balance">
                    Premier diagnostic avec HexaGlue
                </h1>
                <a
                  href="https://github.com/hexaglue/case-study-ecommerce/tree/step/1-discovery"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="mt-4 px-4 py-2 group inline-flex items-center justify-center gap-2 rounded-full border border-astro-dark-100/30 hover:border-astro-dark-100/60 text-base font-normal text-astro-gray-200 hover:text-astro-gray-100 bg-astro-dark-600/30 transition-all ease-in-out duration-500"
                >
                  <Icon name="logos/github" class="size-5" aria-hidden="true" />
                  <code class="text-sm text-amber-400">step/1-discovery</code>
                </a>
                <ul class="mt-6 text-lg text-astro-gray-200 font-light max-w-2xl space-y-1 list-disc list-inside">
                    <li>Intégration d'HexaGlue pour analyser l'architecture du projet.</li>
                    <li>Activation du plugin d'audit pour mesurer la conformité DDD et hexagonale.</li>
                    <li>Génération du premier rapport d'audit architectural.</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Configuration Initiale -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Configuration"
                title="Configuration initiale"
                gradient="bg-orange-yellow-gradient"
            >
                Le plugin Maven HexaGlue analyse le code source à la compilation pour en extraire un modèle architectural.
                Le plugin d'audit (<code>hexaglue-plugin-audit</code>) évalue ce modèle contre les principes DDD et hexagonaux, puis produit un rapport avec un score de conformité.
            </SectionCopy>

            <div class="mt-10">
                <Code code={pomXmlConfig} lang="xml" title="pom.xml" />
            </div>

            <Insight>
                <ul>
                    <li><code>extensions=true</code> : permet à HexaGlue de s'intégrer au cycle de vie Maven et de déclencher l'analyse automatiquement à la compilation</li>
                    <li><code>basePackage</code> : le package racine à analyser, toutes les classes sous <code>com.acme.shop</code> seront classifiées</li>
                    <li><code>failOnError=false</code> : le build ne sera pas bloqué par les violations, utile pour un premier diagnostic</li>
                </ul>
            </Insight>

        </div>
    </section>

    <!-- Exécution de l'audit -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Exécution"
                title="Lancement de l'audit"
                gradient="bg-orange-yellow-gradient"
            >
                Grâce à <code>extensions=true</code>, HexaGlue s'intègre automatiquement au cycle Maven :<br>
                <ul>
                    <li>la classification architecturale du code source s'exécute pendant la phase <code>compile</code>,</li>
                    <li>le plugin d'audit évalue le résultat et génère le rapport pendant la phase <code>verify</code>.</li>
                </ul>
            </SectionCopy>

            <div class="mt-10">
                <Code code="mvn verify" lang="shell" title="Shell" />
            </div>
        </div>
    </section>

    <AuditReport description="Résultat de la première exécution de l'audit HexaGlue sur le code existant.">

    <!-- Verdict de l'Audit -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Verdict"
                title="Verdict de l'audit"
                gradient="bg-orange-yellow-gradient"
            >
                Le verdict synthétise le score global, la note et le nombre de violations. C'est la première chose que le développeur voit en ouvrant le rapport.
            </SectionCopy>

            <div class="mt-10">
                <AuditVerdict
                    score={13}
                    grade="F"
                    status="FAILED"
                    violations={{ critical: 19, major: 24 }}
                />
            </div>

            <Insight>
                <p>Le grade F indique une architecture non conforme aux principes DDD et hexagonaux. L'application n'a ni couche de ports, ni identifiants typés, ni séparation domaine/infrastructure. Les 19 violations critiques proviennent toutes du couplage direct entre le domaine et JPA.</p>
            </Insight>
        </div>
    </section>

    <!-- Décomposition du Score -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Score"
                title="Décomposition du score"
                gradient="bg-orange-yellow-gradient"
            >
                Le score global est calculé à partir de 5 dimensions, chacune pondérée selon son importance architecturale.
                Ce tableau montre la contribution de chaque dimension au score de 13/100.
            </SectionCopy>

            <div class="mt-10">
                <KpiTable rows={kpiRows} total="13.2" />
            </div>

            <Insight>
                <ul>
                    <li><strong>DDD Compliance</strong> et <strong>Hexagonal Architecture</strong> à 0% : ces deux dimensions pèsent 50% du score à elles seules, un score nul ici signifie qu'aucun pattern structurel n'est reconnu</li>
                    <li><strong>Dependencies</strong> à 0% : les dépendances vont du domaine vers l'infrastructure, l'inverse de ce qu'attend une architecture hexagonale</li>
                    <li><strong>Coupling</strong> et <strong>Cohesion</strong> sont les seules dimensions qui contribuent au score, grâce à une organisation en packages qui limite partiellement le couplage</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Inventaire Architectural -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Inventaire"
                title="Inventaire architectural"
                gradient="bg-orange-yellow-gradient"
            >
                L'inventaire liste les composants architecturaux détectés par HexaGlue dans le code source : agrégats, entités, value objects, ports, etc.
                Il donne une vue d'ensemble de ce que le code contient du point de vue DDD et hexagonal.
            </SectionCopy>

            <div class="mt-10">
                <InventoryTable rows={inventoryRows} />
            </div>

            <Insight>
                <p>Sans patterns DDD explicites dans le code, HexaGlue classifie par heuristique. Cela produit des faux positifs :</p>
                <ul>
                    <li>Les 14 <strong>value objects</strong> sont en réalité des enums, services et DTOs mal classifiés</li>
                    <li>L'<strong>événement domaine</strong> est un <code>ApplicationEvent</code> Spring, pas un vrai domain event</li>
                    <li>Les 6 <strong>driven ports</strong> sont les repositories Spring Data, correctement identifiés</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Principales Violations -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Violations"
                title="Violations détectées"
                gradient="bg-orange-yellow-gradient"
            >
                Chaque violation correspond à une règle architecturale enfreinte par le code.
                Elles sont classées par sévérité : <strong>Critical</strong> pour les problèmes structurels fondamentaux, <strong>Major</strong> pour les écarts significatifs.
            </SectionCopy>

            <div class="mt-10">
                <ViolationsTable rows={violationRows} />
            </div>

            <Insight>
                <p>Les 19 violations <strong>Critical</strong> ont une cause racine commune : les annotations JPA dans le modèle de domaine.</p>
                <ul>
                    <li><strong>ddd:entity-identity</strong> : les entités JPA utilisent un <code>Long id</code> généré, pas un identifiant métier typé</li>
                    <li><strong>ddd:domain-purity</strong> : le domaine importe <code>javax.persistence</code>, il dépend directement de l'infrastructure</li>
                </ul>
                <p>Les 24 violations <strong>Major</strong> signalent l'absence de structure hexagonale :</p>
                <ul>
                    <li><strong>hexagonal:layer-isolation</strong> : les services appellent les repositories sans passer par des ports</li>
                    <li><strong>hexagonal:port-direction</strong> : les driven ports ne sont consommés par aucun service applicatif</li>
                    <li><strong>hexagonal:port-coverage</strong> : les 6 repositories n'ont pas d'adaptateur d'infrastructure</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Métriques de Qualité -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Qualité"
                title="Métriques de qualité"
                gradient="bg-orange-yellow-gradient"
            >
                Les métriques de qualité mesurent des propriétés structurelles du code : couverture du domaine, proportion de code technique, complexité et respect des frontières d'agrégats.
            </SectionCopy>

            <div class="mt-10">
                <MetricsTable rows={metricRows} />
            </div>

            <Insight>
                <ul>
                    <li><strong>Domain coverage</strong> à 80% : ce chiffre est trompeur, il mesure le ratio de classes dans le package <code>model</code>, pas la conformité DDD réelle</li>
                    <li><strong>Code boilerplate</strong> à 81% : plus de 4 classes sur 5 ne contiennent que des getters/setters, sans logique métier</li>
                    <li><strong>Domain purity</strong> à 58% : près de la moitié du domaine importe des dépendances d'infrastructure</li>
                    <li><strong>Aggregate boundary</strong> à 0% : aucun agrégat identifié, donc aucune frontière de cohérence transactionnelle</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Taux de Classification -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Classification"
                title="Taux de classification"
                gradient="bg-orange-yellow-gradient"
            >
                HexaGlue tente d'attribuer un rôle architectural à chaque type Java du projet (entité, value object, port, service...).
                Le taux de classification indique quelle proportion du code a pu être identifiée.
            </SectionCopy>

            <div class="mt-10 p-6 bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b border-astro-dark-100/15">
                                <th class="pb-3 text-sm font-semibold text-astro-gray-300">Types analysés</th>
                                <th class="pb-3 text-sm font-semibold text-astro-gray-300">Types classifiés</th>
                                <th class="pb-3 text-sm font-semibold text-astro-gray-300">Taux</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="py-3 text-white">50</td>
                                <td class="py-3 text-white">30</td>
                                <td class="py-3 text-white">60%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <Insight>
                <p>40% des types n'ont pas pu être classifiés. Ce sont principalement :</p>
                <ul>
                    <li>des DTOs de transfert entre couches</li>
                    <li>des classes de configuration Spring</li>
                    <li>des exceptions et utilitaires techniques</li>
                </ul>
                <p>Dans une architecture hexagonale, ces types seraient soit générés automatiquement, soit réorganisés dans des couches dédiées.</p>
            </Insight>
        </div>
    </section>

    <!-- Estimation de Remédiation -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Remédiation"
                title="Coût de mise en conformité"
                gradient="bg-orange-yellow-gradient"
            >
                Le tableau de remédiation estime l'effort nécessaire pour corriger chaque catégorie de violation, en distinguant le travail manuel du travail automatisable par HexaGlue.
            </SectionCopy>

            <div class="mt-10">
                <RemediationTable rows={remediationRows} />
            </div>

            <Insight>
                <p>Le coût total estimé est de 44,5 jours de travail manuel. HexaGlue peut en automatiser une partie :</p>
                <ul>
                    <li><strong>Automatisable</strong> : génération des adaptateurs JPA pour les 6 repositories (18 jours économisés)</li>
                    <li><strong>Manuel</strong> : restructuration du domaine, création des identifiants typés, suppression des annotations JPA (26,5 jours)</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Stabilité des Packages -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Stabilité"
                title="Stabilité des packages"
                gradient="bg-orange-yellow-gradient"
            >
                L'analyse de stabilité évalue les dépendances entre packages selon les métriques de Robert C. Martin.
                Elle identifie les packages fragiles (très sollicités mais sans abstraction) et les packages bien positionnés.
            </SectionCopy>

            <div class="mt-10">
                <PackageStabilityTable rows={packageStabilityRows} />
            </div>

            <Insight>
                <p>Deux packages sont en <strong>Zone of Pain</strong> :</p>
                <ul>
                    <li><strong>shop.model</strong> : 18 dépendants, aucune abstraction. Toute modification d'une entité se propage à l'ensemble de l'application</li>
                    <li><strong>shop.dto</strong> : même problème à plus petite échelle, avec 5 dépendants et 0% d'abstraction</li>
                </ul>
                <p>Ces packages concentrent le risque : ils sont très concrets et très sollicités, ce qui rend chaque changement coûteux.</p>
            </Insight>
        </div>
    </section>

    </AuditReport>

    <!-- Bilan -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Bilan"
                title="Ce que révèle cette étape"
                gradient="bg-orange-yellow-gradient"
            >
                Ce premier audit établit une photographie quantifiée de l'état architectural du projet.
                Il sert de ligne de base pour mesurer les progrès à chaque étape de la migration.
            </SectionCopy>

            <Insight class="mt-10">
                <p>Les constats principaux :</p>
                <ul>
                    <li><strong>Score 13/100 (Grade F)</strong> : l'architecture ne respecte aucun principe DDD ni hexagonal</li>
                    <li><strong>19 violations critiques</strong> : toutes liées au couplage domaine/JPA (annotations de persistance dans le modèle)</li>
                    <li><strong>81% de boilerplate</strong> : le code métier est noyé dans les getters/setters techniques</li>
                    <li><strong>44,5 jours de remédiation</strong> estimés, dont 18 automatisables par HexaGlue</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Transition -->
    <section class="relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <div class="bg-amber-500/5 border border-amber-500/20 rounded-xl p-6">
                <p class="text-lg text-astro-gray-200">
                    L'étape suivante consiste à supprimer le bruit dans la classification pour affiner le diagnostic.
                </p>
            </div>
        </div>
    </section>

    <!-- Navigation -->
    <section class="py-16 relative">
        <div class="w-full max-w-4xl mx-auto px-4 sm:px-8">
            <div class="max-w-5xl mx-auto">
                <StepNavigation
                    prev={{
                        href: '/case-studies/ecommerce-migration/step-0-legacy/',
                        label: 'Étape 0 - Le monolithe Spring Boot d\'origine'
                    }}
                    next={{
                        href: '/case-studies/ecommerce-migration/step-2-configured/',
                        label: 'Étape 2 - Suppression du bruit'
                    }}
                />
            </div>
        </div>
        <div
            class="absolute inset-x-0 bottom-0 h-[50vw] translate-y-[60%] bg-orange-yellow-gradient opacity-50 mask-radial-gradient pointer-events-none"
        ></div>
    </section>
</MainLayout>
