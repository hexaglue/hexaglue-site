---
import MainLayout from '~/layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
import { Code } from 'astro-expressive-code/components';
import StepNavigation from './_components/StepNavigation.astro';
import AuditVerdict from './_components/AuditVerdict.astro';
import KpiTable, { type KpiRow } from './_components/KpiTable.astro';
import ViolationsTable, { type ViolationRow } from './_components/ViolationsTable.astro';
import MetricsTable from './_components/MetricsTable.astro';
import InventoryTable, { type InventoryRow } from './_components/InventoryTable.astro';
import PackageStabilityTable, { type PackageStabilityRow } from './_components/PackageStabilityTable.astro';
import RemediationTable, { type RemediationRow } from './_components/RemediationTable.astro';
import SectionCopy from '../../_components/SectionCopy.astro';
import AmberStardust from '../../_components/landing-page/AmberStardust.astro';
import Insight from '~/components/Insight.astro';
import ModificationList from './_components/ModificationList.astro';
import ModificationGroup from './_components/ModificationGroup.astro';
import ModificationItem from './_components/ModificationItem.astro';

const drivingPortCode = `public interface OrderUseCases {
    OrderResponse createOrder(CreateOrderRequest request);
    OrderResponse placeOrder(Long orderId);
    OrderResponse cancelOrder(Long orderId, String reason);
    OrderResponse getOrder(Long orderId);
    OrderResponse getOrderByNumber(String orderNumber);
    List<OrderResponse> getOrdersByCustomer(Long customerId);
}`;

const applicationServiceCode = `@Service
@Transactional
public class OrderApplicationService implements OrderUseCases {

    private final OrderRepository orderRepository;
    private final CustomerRepository customerRepository;
    private final ProductRepository productRepository;
    private final InventoryUseCases inventoryUseCases;
    private final NotificationSender notificationSender;

    public OrderApplicationService(
            OrderRepository orderRepository,
            CustomerRepository customerRepository,
            ProductRepository productRepository,
            InventoryUseCases inventoryUseCases,
            NotificationSender notificationSender) {
        this.orderRepository = orderRepository;
        // ...
    }
}`;

const dualInterfaceRepoCode = `@Repository
public interface JpaOrderRepository
        extends JpaRepository<Order, Long>, OrderRepository {
}`;

const packageStructure = `com.acme.shop/
├── domain/
│   ├── shared/         (BaseEntity)
│   ├── order/          (Order, OrderLine, OrderStatus)
│   ├── customer/       (Customer)
│   ├── product/        (Product, Category)
│   ├── inventory/      (Inventory, StockMovement)
│   ├── payment/        (Payment, PaymentStatus)
│   └── shipping/       (Shipment, ShippingRate)
├── ports/
│   ├── in/             (7 driving ports)
│   └── out/            (8 driven ports)
├── application/        (7 *ApplicationService)
└── infrastructure/
    ├── web/            (5 controllers + dto/)
    ├── persistence/    (6 JpaXxxRepository)
    ├── external/       (2 adapters)
    └── config/         (AppConfig, SecurityConfig)`;

const kpiRows: KpiRow[] = [
    { dimension: 'DDD Compliance', value: '0%', weight: '25%', contribution: '0.0', threshold: '≥ 90%', status: 'CRITICAL', delta: '=' },
    { dimension: 'Hexagonal Architecture', value: '100%', weight: '25%', contribution: '25.0', threshold: '≥ 90%', status: 'OK', delta: '+60' },
    { dimension: 'Dependencies', value: '0%', weight: '20%', contribution: '0.0', threshold: '≥ 80%', status: 'CRITICAL', delta: '=' },
    { dimension: 'Coupling', value: '37%', weight: '15%', contribution: '5.6', threshold: '≥ 70%', status: 'CRITICAL', delta: '+16' },
    { dimension: 'Cohesion', value: '64%', weight: '15%', contribution: '9.6', threshold: '≥ 80%', status: 'CRITICAL', delta: '+6' },
];

const inventoryRows: InventoryRow[] = [
    { component: 'Aggregate Roots', count: 0, delta: '=', observation: '' },
    { component: 'Entities', count: 9, delta: '=', observation: 'Toujours @Entity JPA' },
    { component: 'Value Objects', count: 3, delta: '-3', observation: '3 enums conservés' },
    { component: 'Identifiers', count: 0, delta: '=', observation: '' },
    { component: 'Domain Events', count: 0, delta: '=', observation: '' },
    { component: 'Driving Ports', count: 6, delta: '+6', observation: '6 *UseCases créés' },
    { component: 'Driven Ports', count: 9, delta: '+3', observation: '6 repos + 3 ports externes' },
];

const violationRows: ViolationRow[] = [
    { constraint: 'ddd:entity-identity', count: 9, severity: 'CRITICAL', delta: '=', observation: 'Mêmes 9 entités sans identité' },
    { constraint: 'ddd:domain-purity', count: 9, severity: 'CRITICAL', delta: '=', observation: '9 classes model/ avec imports JPA' },
    { constraint: 'hexagonal:port-coverage', count: 0, severity: 'MAJOR', delta: '-6', observation: 'Tous les ports ont un adaptateur' },
    { constraint: 'hexagonal:port-direction', count: 0, severity: 'MAJOR', delta: '-6', observation: 'Tous les driven ports utilisés' },
];

const packageStabilityRows: PackageStabilityRow[] = [
    { package: 'ports.out', ca: 15, ce: 9, instability: 0.38, abstractness: 1.00, distance: 0.38, zone: 'Main Sequence' },
    { package: 'ports.in', ca: 12, ce: 9, instability: 0.43, abstractness: 1.00, distance: 0.43, zone: 'Main Sequence' },
    { package: 'domain.order', ca: 7, ce: 3, instability: 0.30, abstractness: 0.00, distance: 0.70, zone: 'Main Sequence' },
    { package: 'domain.product', ca: 9, ce: 1, instability: 0.10, abstractness: 0.00, distance: 0.90, zone: 'Zone of Pain' },
    { package: 'application', ca: 0, ce: 26, instability: 1.00, abstractness: 0.00, distance: 0.00, zone: 'Main Sequence' },
];

const remediationRows: RemediationRow[] = [
    {
        constraint: 'ddd:entity-identity',
        violations: 9,
        severity: 'CRITICAL',
        manualEffort: 4.5,
        hexaglueEffort: 4.5,
        description: 'Entités sans identifiant typé',
    },
    {
        constraint: 'ddd:domain-purity',
        violations: 9,
        severity: 'CRITICAL',
        manualEffort: 13.5,
        hexaglueEffort: 13.5,
        description: 'Annotations JPA dans le domaine',
    },
    {
        constraint: 'hexagonal:port-coverage',
        violations: 0,
        severity: 'MAJOR',
        manualEffort: 0,
        hexaglueEffort: 0,
        description: 'Ports couverts par des adaptateurs',
    },
    {
        constraint: 'hexagonal:port-direction',
        violations: 0,
        severity: 'MAJOR',
        manualEffort: 0,
        hexaglueEffort: 0,
        description: 'Ports correctement orientés',
    },
];
---

<MainLayout
    title="Étape 3 - Réorganisation en couches hexagonales | Migration E-Commerce"
    description="Restructuration en architecture hexagonale : création de 7 driving ports, 8 driven ports et 7 services applicatifs. Score 40/100, violations -12."
>
    <!-- Hero Section -->
    <section class="pt-24 pb-16 md:pt-32 md:pb-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <AmberStardust height="h-64 md:h-80" />
        <div class="max-w-5xl mx-auto">
            <div class="mt-8 max-w-3xl">
                <span class="bg-clip-text text-transparent bg-orange-yellow-gradient font-semibold text-sm uppercase tracking-wider">
                    Étape 3
                </span>
                <h1 class="mt-4 font-heading heading-bold text-4xl md:text-5xl lg:text-6xl text-white text-balance">
                    Réorganisation en couches hexagonales
                </h1>
                <a
                  href="https://github.com/hexaglue/case-study-ecommerce/tree/step/3-hexagonal"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="mt-4 px-4 py-2 group inline-flex items-center justify-center gap-2 rounded-full border border-astro-dark-100/30 hover:border-astro-dark-100/60 text-base font-normal text-astro-gray-200 hover:text-astro-gray-100 bg-astro-dark-600/30 transition-all ease-in-out duration-500"
                >
                  <Icon name="logos/github" class="size-5" aria-hidden="true" />
                  <code class="text-sm text-amber-400">step/3-hexagonal</code>
                </a>
                <ul class="mt-6 text-lg text-astro-gray-200 font-light max-w-2xl space-y-1 list-disc list-inside">
                    <li>Réorganisation des packages selon l'architecture hexagonale.</li>
                    <li>Création de ports (driving et driven).</li>
                    <li>Services applicatifs et repositories en double interface.</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Modifications effectuées -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Modifications"
                title="Modifications effectuées"
                description="Restructuration de l'application selon l'architecture hexagonale avec création de ports et services applicatifs."
                gradient="bg-orange-yellow-gradient"
            />
            <ModificationList class="mt-10">
                <ModificationGroup layer="domain">
                    <ModificationItem action="move" count={13} label="classes domaine" details="vers domain/order, domain/customer, domain/product, etc." />
                </ModificationGroup>
                <ModificationGroup layer="application">
                    <ModificationItem action="create" count={7} label="services applicatifs" details="OrderApplicationService, CustomerApplicationService, etc." />
                </ModificationGroup>
                <ModificationGroup layer="ports">
                    <ModificationItem action="define" count={7} label="driving ports" details="OrderUseCases, CustomerUseCases, ProductUseCases, etc." />
                    <ModificationItem action="define" count={8} label="driven ports" details="OrderRepository, CustomerRepository, NotificationSender, etc." />
                </ModificationGroup>
                <ModificationGroup layer="adapters">
                    <ModificationItem action="implement" count={6} label="driven adapters" details="JpaOrderRepository extends JpaRepository, OrderRepository" />
                    <ModificationItem action="implement" count={2} label="adapters externes" details="PaymentGatewayAdapter, NotificationAdapter" />
                </ModificationGroup>
                <ModificationGroup layer="configuration">
                    <ModificationItem action="configure" label="hexaglue.yaml" details="exclude: infrastructure.**, application.**" />
                </ModificationGroup>
            </ModificationList>

            <Insight>
                <ul>
                    <li><strong>Driving ports</strong> : exposent les cas d'usage au monde extérieur</li>
                    <li><strong>Driven ports</strong> : abstraient les dépendances externes</li>
                </ul>
                <p>Cette inversion de dépendance permet de tester le domaine sans infrastructure.</p>
            </Insight>
        </div>
    </section>

    <!-- Structure hexagonale -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Structure"
                title="Organisation des packages"
                description="Nouvelle structure avec séparation domaine, ports, application et infrastructure."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <Code code={packageStructure} lang="text" title="Structure hexagonale" />
            </div>

            <Insight>
                <ul>
                    <li><strong>Domaine</strong> : organisé par sous-domaine métier (order, customer, product)</li>
                    <li><strong>Ports</strong> : définissent les contrats d'interface</li>
                    <li><strong>Infrastructure</strong> : implémente avec les technologies concrètes (JPA, REST)</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Verdict de l'audit -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Verdict"
                title="Verdict de l'audit"
                description="Résultat après restructuration hexagonale avec création des ports et services applicatifs."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <AuditVerdict
                    score={40}
                    grade="F"
                    status="FAILED"
                    violations={{ critical: 18, major: 0 }}
                    delta={{ score: 19, violations: -12 }}
                />
            </div>

            <Insight>
                <ul>
                    <li><strong>+19 points</strong> : structuration hexagonale en place</li>
                    <li><strong>18 violations CRITICAL</strong> restantes : toutes liées au DDD (domaine couplé à JPA)</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Indicateurs clés -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Score"
                title="Décomposition du score"
                description="Contribution de chaque dimension au score global de 40/100."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <KpiTable rows={kpiRows} total="40.2" />
            </div>

            <Insight>
                <ul>
                    <li><strong>Hexagonal Architecture</strong> à 100% : tous les ports détectés avec leurs adaptateurs</li>
                    <li><strong>DDD Compliance</strong> reste à 0% : entités JPA sans identifiants typés ni frontières de cohérence</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Inventaire architectural -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Inventaire"
                title="Inventaire architectural"
                description="Composants détectés après restructuration hexagonale."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <InventoryTable rows={inventoryRows} />
            </div>

            <Insight>
                <ul>
                    <li><strong>6 driving ports</strong> et <strong>9 driven ports</strong> détectés</li>
                    <li>Les 9 entités JPA restent classifiées <strong>ENTITY</strong> (pas AGGREGATE_ROOT) : absence d'identifiants typés</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Violations détectées -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Violations"
                title="Violations détectées"
                description="Contraintes architecturales non respectées après restructuration."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <ViolationsTable rows={violationRows} />
            </div>

            <Insight>
                <ul>
                    <li><strong>Violations hexagonales résolues</strong> : port-coverage, port-direction</li>
                    <li><strong>Violations DDD persistent</strong> : annotations JPA dans le domaine (@Entity, @ManyToOne)</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Métriques techniques -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Qualité"
                title="Métriques de qualité"
                description="Indicateurs structurels mesurés sur le code restructuré."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <MetricsTable
                    rows={[
                        { metric: 'Domain coverage', value: '44.44%', threshold: 'min 30%', status: 'OK', delta: '-26.99' },
                        { metric: 'Code boilerplate', value: '100.00%', threshold: 'max 50%', status: 'CRITICAL', delta: '=' },
                        { metric: 'Domain purity', value: '25.00%', threshold: 'min 100%', status: 'CRITICAL', delta: '-15.00' },
                        { metric: 'Aggregate boundary', value: '0.00%', threshold: 'min 80%', status: 'CRITICAL', delta: '=' },
                        { metric: 'Code complexity', value: '1.00', threshold: 'max 10', status: 'OK', delta: '=' }
                    ]}
                />
            </div>

            <Insight>
                <ul>
                    <li><strong>Domain purity</strong> à 25% : domaine pollué par JPA</li>
                    <li><strong>Code boilerplate</strong> à 100% : annotations JPA omniprésentes</li>
                    <li><strong>Aggregate boundary</strong> à 0% : aucune frontière de cohérence DDD</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Coût de remédiation -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Remédiation"
                title="Coût de mise en conformité"
                description="Estimation de l'effort de remédiation avec et sans HexaGlue pour atteindre la conformité architecturale."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <RemediationTable rows={remediationRows} />
            </div>

            <Insight>
                <ul>
                    <li><strong>Effort divisé par 2</strong> grâce à la structure hexagonale</li>
                    <li><strong>18 jours restants</strong> : purification du domaine (suppression JPA, identifiants typés)</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Exemples de code -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Code"
                title="Exemples de code"
                description="Implémentation des ports et services applicatifs."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10 space-y-6">
                <Code code={drivingPortCode} lang="java" title="OrderUseCases.java - Driving Port" />
                <Code code={applicationServiceCode} lang="java" title="OrderApplicationService.java" />
                <Code code={dualInterfaceRepoCode} lang="java" title="JpaOrderRepository.java - Dual Interface" />
            </div>

            <Insight>
                <ul>
                    <li><strong>Driving port</strong> : définit le contrat des cas d'usage</li>
                    <li><strong>Service applicatif</strong> : orchestre le domaine via les driven ports</li>
                    <li><strong>Repository</strong> : double interface combinant port domaine et Spring Data</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Stabilité des packages -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Stabilité"
                title="Stabilité des packages"
                description="Analyse des couplages selon les métriques de Robert C. Martin."
                gradient="bg-orange-yellow-gradient"
            />

            <div class="mt-10">
                <PackageStabilityTable rows={packageStabilityRows} />
            </div>

            <Insight>
                <ul>
                    <li><strong>ports.in</strong> et <strong>ports.out</strong> sur la Main Sequence : abstraits et stables</li>
                    <li><strong>domain.product</strong> en Zone of Pain (D=0.90) : normal pour un domaine métier central</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Bilan Section -->
    <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <SectionCopy
                label="Bilan"
                title="Ce que révèle cette étape"
                description="Restructuration hexagonale réussie, mais le domaine reste à purifier."
                gradient="bg-orange-yellow-gradient"
            />

            <Insight class="mt-10">
                <ul>
                    <li>Score 40/100 (+19) : gain substantiel grâce à la structure hexagonale</li>
                    <li>Hexagonal Architecture à 100% : tous les ports ont leurs adaptateurs</li>
                    <li>DDD Compliance toujours à 0% : le domaine est couplé à JPA</li>
                    <li>0 violation MAJOR : seules les 18 violations CRITICAL (DDD) restent</li>
                    <li>Remédiation divisée par 2 : 37.5j → 18j</li>
                    <li>Prochaine étape : purifier le domaine (identifiants typés, suppression JPA)</li>
                </ul>
            </Insight>
        </div>
    </section>

    <!-- Step Navigation -->
    <section class="py-16 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
        <div class="max-w-5xl mx-auto">
            <StepNavigation
                prev={{ href: '/case-studies/ecommerce-migration/step-2-configured/', label: 'Étape 2 - Suppression du bruit' }}
                next={{ href: '/case-studies/ecommerce-migration/step-4-pure-domain/', label: 'Étape 4 - Purification du domaine' }}
            />
        </div>
    </section>
</MainLayout>
