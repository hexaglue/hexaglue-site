---
import MainLayout from '~/layouts/MainLayout.astro';
import { Icon } from 'astro-icon/components';
import { Code } from 'astro-expressive-code/components';
import StepNavigation from '../_components/StepNavigation.astro';
import AuditReport from '../_components/AuditReport.astro';
import AuditVerdict from '../_components/AuditVerdict.astro';
import KpiTable, { type KpiRow } from '../_components/KpiTable.astro';
import ViolationsTable, { type ViolationRow } from '../_components/ViolationsTable.astro';
import MetricsTable from '../_components/MetricsTable.astro';
import SectionCopy from '../../_components/SectionCopy.astro';
import PurpleStardust from '../../_components/landing-page/PurpleStardust.astro';
import Link from '../../_components/Link.astro';
import Insight from '~/components/Insight.astro';
import ModificationList from '../_components/ModificationList.astro';
import ModificationGroup from '../_components/ModificationGroup.astro';
import ModificationItem from '../_components/ModificationItem.astro';

const title = 'Étape 6 - Architecture hexagonale opérationnelle | Migration E-Commerce';
const description = 'Architecture hexagonale opérationnelle : application e-commerce fonctionnelle de bout en bout. Score final 63/100, 100% conformité hexagonale, 1 violation.';

const kpiRows: KpiRow[] = [
    { dimension: 'DDD Compliance', value: '95%', weight: '25%', contribution: '23.75', threshold: '≥ 90%', status: 'OK', delta: '=' },
    { dimension: 'Hexagonal Architecture', value: '100%', weight: '25%', contribution: '25.0', threshold: '≥ 90%', status: 'OK', delta: '+10' },
    { dimension: 'Dependencies', value: '0%', weight: '20%', contribution: '0.0', threshold: '≥ 80%', status: 'CRITICAL', delta: '=' },
    { dimension: 'Coupling', value: '31%', weight: '15%', contribution: '4.65', threshold: '≥ 70%', status: 'CRITICAL', delta: '=' },
    { dimension: 'Cohesion', value: '64%', weight: '15%', contribution: '9.6', threshold: '≥ 80%', status: 'WARNING', delta: '+1' },
];

const violationRows: ViolationRow[] = [
    { constraint: 'hexagonal:layer-isolation', count: 0, severity: 'MAJOR', delta: '-2', observation: 'InventoryUseCases refactorée' },
    { constraint: 'ddd:aggregate-boundary', count: 1, severity: 'MAJOR', delta: '=', observation: 'OrderLine - limitation classificateur' },
];
---

<MainLayout title={title} description={description}>
  <!-- Hero -->
  <section class="pt-24 pb-16 md:pt-32 md:pb-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <PurpleStardust height="h-64 md:h-80" />
    <div class="max-w-5xl mx-auto">
      <div class="mt-8 max-w-3xl">
        <span class="bg-clip-text text-transparent bg-blue-purple-gradient font-semibold text-sm uppercase tracking-wider">
          Étape 6
        </span>
        <h1 class="mt-4 font-heading heading-bold text-4xl md:text-5xl lg:text-6xl text-white text-balance">
          Architecture hexagonale opérationnelle
        </h1>
        <a
          href="https://github.com/hexaglue/case-study-ecommerce/tree/main" title="Voir le code source sur GitHub"
          target="_blank"
          rel="noopener noreferrer"
          class="mt-4 px-4 py-2 group inline-flex items-center justify-center gap-2 rounded-full border border-astro-dark-100/30 hover:border-astro-dark-100/60 text-base font-normal text-astro-gray-200 hover:text-astro-gray-100 bg-astro-dark-600/30 transition-all ease-in-out duration-500"
        >
          <Icon name="logos/github" class="size-5" aria-hidden="true" />
          <code class="text-sm text-purple-400">main</code>
        </a>
        <ul class="mt-6 text-lg text-astro-gray-200 font-light max-w-2xl space-y-1 list-disc list-inside">
          <li>Validation bout en bout avec infrastructure générée.</li>
          <li>Migration Long→UUID, convention reconstitute().</li>
          <li>Refactoring InventoryUseCases.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Modifications effectuées -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Modifications"
        title="Modifications effectuées"
        gradient="bg-blue-purple-gradient"
      >
        Cette dernière étape résout les points identifiés par HexaGlue pour rendre l'application fonctionnelle de bout en bout :
        migration des identifiants, convention de reconstruction des agrégats, et refactoring du dernier composant non classifié.
      </SectionCopy>

      <ModificationList class="mt-10">
        <ModificationGroup layer="domain">
          <ModificationItem action="fix" count={6} label="identifiants" details="Long → UUID avec méthode generate()" />
          <ModificationItem action="implement" label="convention reconstitute()" details="factory method pour restaurer les agrégats depuis la base" />
        </ModificationGroup>
        <ModificationGroup layer="ports">
          <ModificationItem action="refactor" label="InventoryUseCases" details="5 → 2 méthodes, Conflicting → Driving Port" />
        </ModificationGroup>
        <ModificationGroup layer="application">
          <ModificationItem action="refactor" label="OrderApplicationService" details="utilise InventoryRepository (driven port) directement" />
        </ModificationGroup>
        <ModificationGroup layer="adapters">
          <ModificationItem action="create" label="DTOs de réponse REST" details="évite JSON imbriqué (CustomerId.value.value)" />
          <ModificationItem action="implement" label="POST /api/inventory/initialize" details="endpoint pour initialiser le stock" />
        </ModificationGroup>
      </ModificationList>

      <Insight>
        <p><strong>6 corrections ciblées</strong>, chacune découlant d'un constat du rapport d'audit :</p>
        <ul>
          <li><strong>Domaine</strong> : migration <code>Long</code> &rarr; <code>UUID</code> avec méthode <code>generate()</code>, et ajout de la convention <code>reconstitute()</code> pour la restauration des agrégats depuis la base</li>
          <li><strong>Ports</strong> : <code>InventoryUseCases</code> refactoré de 5 à 2 méthodes, classifié Driving Port au lieu de Conflicting</li>
          <li><strong>Application</strong> : <code>OrderApplicationService</code> utilise directement les driven ports au lieu de passer par des use cases intermédiaires</li>
          <li><strong>Adaptateurs</strong> : DTOs de réponse REST pour éviter la sérialisation imbriquée, et endpoint d'initialisation du stock</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Test bout en bout -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Validation"
        title="Test bout en bout"
        gradient="bg-blue-purple-gradient"
      >
        Ce scénario exerce le parcours complet d'une commande : création du client et du produit, initialisation du stock,
        passage de commande, paiement, et livraison.<br>
        Chaque appel REST traverse la stack entière : contrôleur &rarr; service applicatif &rarr; domaine &rarr; infrastructure générée.
      </SectionCopy>

      <div class="mt-10 bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="border-b border-astro-dark-100/15">
                <th class="px-6 py-4 text-sm font-semibold text-astro-gray-200">#</th>
                <th class="px-6 py-4 text-sm font-semibold text-astro-gray-200">Endpoint</th>
                <th class="px-6 py-4 text-sm font-semibold text-astro-gray-200">Résultat</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-astro-dark-100/15">
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">1</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">POST /api/customers</td>
                <td class="px-6 py-4 text-sm text-white">Customer créé (UUID)</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">2</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">POST /api/products</td>
                <td class="px-6 py-4 text-sm text-white">Product créé</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">3</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">POST /api/inventory/initialize</td>
                <td class="px-6 py-4 text-sm text-white">HTTP 201</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">4</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">{"GET /api/inventory/{id}/available"}</td>
                <td class="px-6 py-4 text-sm text-white">100</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">5</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">POST /api/orders</td>
                <td class="px-6 py-4 text-sm text-white">Order PLACED, 2599.98 EUR</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">6</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">{"GET /api/inventory/{id}/available"}</td>
                <td class="px-6 py-4 text-sm text-white">98 (2 réservées)</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">7</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">POST /api/payments</td>
                <td class="px-6 py-4 text-sm text-white">Payment AUTHORIZED</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">8</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">POST /api/payments/capture</td>
                <td class="px-6 py-4 text-sm text-white">Payment CAPTURED</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">9</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">POST /api/shipments</td>
                <td class="px-6 py-4 text-sm text-white">Shipment PENDING</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">10</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">{"POST /api/shipments/{tracking}/ship"}</td>
                <td class="px-6 py-4 text-sm text-white">IN_TRANSIT</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">11</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">{"POST /api/shipments/{tracking}/deliver"}</td>
                <td class="px-6 py-4 text-sm text-white">DELIVERED</td>
              </tr>
              <tr>
                <td class="px-6 py-4 text-sm text-astro-gray-200 font-mono">12</td>
                <td class="px-6 py-4 text-sm font-mono text-purple-300">{"GET /api/orders/{id}"}</td>
                <td class="px-6 py-4 text-sm text-white">Order DELIVERED</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <Insight>
        <p><strong>12 appels REST, 0 échec</strong> : le parcours complet fonctionne de bout en bout.</p>
        <ul>
          <li><strong>Persistance générée</strong> : chaque entité est sauvegardée via les repositories et mappers produits par HexaGlue au compile-time</li>
          <li><strong>Stock décrémenté</strong> : la commande de 2 unités fait passer le stock disponible de 100 à 98, preuve que la logique métier traverse toutes les couches</li>
          <li><strong>Cycle complet</strong> : la commande passe par les états PLACED &rarr; PAID &rarr; DELIVERED, orchestrés par les services applicatifs via les driven ports</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Build Verification -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Build"
        title="Vérification du build"
        gradient="bg-blue-purple-gradient"
      >
        Avant le test fonctionnel, les trois étapes du build Maven confirment que le projet compile, passe l'audit, et démarre correctement.
      </SectionCopy>

      <div class="mt-10 bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-8">
        <div class="space-y-4">
          <div class="flex items-start gap-3">
            <Icon name="ri:checkbox-circle-line" class="w-6 h-6 text-green-400 flex-shrink-0 mt-1" />
            <div>
              <code class="text-sm font-mono text-purple-300">mvn clean compile</code>
              <p class="text-sm text-astro-gray-200 mt-1">
                BUILD SUCCESS (99 fichiers source : 68 manuels + 28 générés + 3 MapStruct)
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <Icon name="ri:checkbox-circle-line" class="w-6 h-6 text-green-400 flex-shrink-0 mt-1" />
            <div>
              <code class="text-sm font-mono text-purple-300">mvn clean verify</code>
              <p class="text-sm text-astro-gray-200 mt-1">
                BUILD SUCCESS (audit PASSED avec 1 avertissement)
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <Icon name="ri:checkbox-circle-line" class="w-6 h-6 text-green-400 flex-shrink-0 mt-1" />
            <div>
              <code class="text-sm font-mono text-purple-300">mvn spring-boot:run</code>
              <p class="text-sm text-astro-gray-200 mt-1">
                Application démarre sur le port 8080
              </p>
            </div>
          </div>
        </div>
      </div>

      <Insight>
        <ul>
          <li><strong><code>mvn clean compile</code></strong> : 99 fichiers compilés (68 manuels + 28 générés par HexaGlue + 3 MapStruct). La génération s'exécute automatiquement pendant la phase <code>compile</code></li>
          <li><strong><code>mvn clean verify</code></strong> : l'audit passe avec un seul avertissement (<code>aggregate-boundary</code>). Le build n'échoue pas car le seuil est configuré sur Critical</li>
          <li><strong><code>mvn spring-boot:run</code></strong> : l'application démarre sur le port 8080, prête pour le test de bout en bout</li>
        </ul>
      </Insight>
    </div>
  </section>

  <AuditReport description="Résultat final après corrections et validation fonctionnelle.">

  <!-- Audit Verdict -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Verdict"
        title="Verdict de l'audit"
        gradient="bg-orange-yellow-gradient"
      >
        Le dernier rapport d'audit confirme la progression : 63/100, grade D, et une seule violation Major résiduelle.
        L'architecture hexagonale atteint 100% de conformité.
      </SectionCopy>

      <div class="mt-10">
        <AuditVerdict
          score={63}
          grade="D"
          status="PASSED_WITH_WARNINGS"
          violations={{ critical: 0, major: 1 }}
          delta={{ score: 3, violations: -2 }}
        />
      </div>

      <Insight>
        <p>Le score progresse de 3 points grâce au refactoring de <code>InventoryUseCases</code> qui résout les 2 violations <code>layer-isolation</code>.</p>
        <ul>
          <li><strong>Statut PASSED (warnings)</strong> : aucune violation Blocker ou Critical. La seule violation restante (<code>aggregate-boundary</code>) est de sévérité Major : elle relève d'une limitation du classificateur, pas d'un défaut d'architecture</li>
          <li><strong>Score plafonné à 63</strong> : les dimensions DDD (95%) et Hexagonal (100%) sont proches de la perfection, mais Dependencies (0%) et Coupling (31%) captent 35% du score total et restent hors périmètre hexagonal</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- KPI Table -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Score"
        title="Décomposition du score"
        gradient="bg-orange-yellow-gradient"
      >
        Le score final de 63/100 reflète l'état de chaque dimension architecturale.<br>
        Deux dimensions plafonnent le score : Dependencies (0%) et Coupling (31%), qui ne relèvent pas de l'architecture hexagonale.
      </SectionCopy>

      <div class="mt-10">
        <KpiTable rows={kpiRows} total="63.0" />
      </div>

      <Insight>
        <ul>
          <li><strong>Hexagonal Architecture passe à 100%</strong> (+10) : le refactoring de <code>InventoryUseCases</code> élimine la dernière dépendance non classifiée. Tous les services applicatifs sont des POJOs purs</li>
          <li><strong>Dependencies (0%) et Coupling (31%)</strong> restent inchangés : ces dimensions mesurent les cycles de dépendances et le couplage entre packages, indépendamment de l'architecture hexagonale</li>
          <li><strong>Cohesion monte à 64%</strong> (+1) : légère amélioration due à la simplification de <code>InventoryUseCases</code></li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Violations Table -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Violations"
        title="Violations détectées"
        gradient="bg-orange-yellow-gradient"
      >
        Le refactoring de <code>InventoryUseCases</code> résout les 2 violations <code>layer-isolation</code>.<br>
        Une seule violation subsiste, liée à une limitation du classificateur.
      </SectionCopy>

      <div class="mt-10">
        <ViolationsTable rows={violationRows} />
      </div>

      <Insight>
        <ul>
          <li><strong><code>layer-isolation</code> résolues (-2)</strong> : <code>InventoryUseCases</code> est passé de Conflicting à Driving Port, les services applicatifs qui en dépendaient ne violent plus l'isolation des couches</li>
          <li><strong><code>aggregate-boundary</code> subsiste (1)</strong> : <code>OrderLine</code> n'a pas d'identifiant explicite, donc le classificateur ne le reconnaît pas comme Entity membre de l'agrégat <code>Order</code>. C'est une limitation connue, pas un défaut d'architecture</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Metrics Table -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Qualité"
        title="Métriques de qualité"
        gradient="bg-orange-yellow-gradient"
      >
        Les métriques de qualité montrent l'état final du code après toutes les corrections.<br>
        La pureté du domaine et la couverture des repositories sont à 100%, confirmant la séparation nette entre domaine et infrastructure.
      </SectionCopy>

      <div class="mt-10">
        <MetricsTable
          rows={[
            { metric: 'Domain purity', value: '100%', threshold: 'min 100%', status: 'OK', delta: '=' },
            { metric: 'Aggregate boundary', value: '0.00%', threshold: 'min 80%', status: 'CRITICAL', delta: '=' },
            { metric: 'Repository coverage', value: '100%', threshold: 'min 100%', status: 'OK', delta: '=' },
            { metric: 'Code complexity', value: '1.11', threshold: 'max 10', status: 'OK', delta: '-0.01' },
            { metric: 'Aggregate avg size', value: '15.33', threshold: 'max 20', status: 'OK', delta: '+1.00' },
            { metric: 'Code boilerplate', value: '81.48%', threshold: 'max 50%', status: 'CRITICAL', delta: '+1.28' },
          ]}
        />
      </div>

      <Insight>
        <ul>
          <li><strong><code>domain.purity</code> à 100%</strong> : le domaine ne contient aucune dépendance technique. Les annotations JPA, Spring et MapStruct sont toutes dans la couche infrastructure</li>
          <li><strong><code>aggregate.boundary</code> à 0%</strong> : inchangé, lié à la limitation du classificateur sur <code>OrderLine</code></li>
          <li><strong><code>code.complexity</code> à 1.11</strong> : la complexité cyclomatique reste très basse, signe d'un code métier lisible</li>
          <li><strong><code>code.boilerplate</code> à 81%</strong> : le ratio élevé reflète le volume de code généré (entités JPA, mappers, repositories), qui est technique par nature</li>
        </ul>
      </Insight>
    </div>
  </section>

  </AuditReport>

  <!-- Final Summary -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy label="Résultat" title="Bilan final" gradient="bg-blue-purple-gradient" />

      <div class="mt-8 bg-gradient-to-br from-purple-500/10 to-pink-500/10 border border-purple-500/20 rounded-2xl p-8">
        <div class="flex items-start gap-4 mb-6">
          <Icon name="ri:trophy-line" class="w-8 h-8 text-yellow-400 flex-shrink-0" />
          <div>
            <h3 class="text-2xl font-bold text-white mb-2">Application fonctionnelle</h3>
            <p class="text-astro-gray-200">
              L'application fonctionne de bout en bout avec infrastructure 100% générée.
            </p>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <div>
            <div class="text-3xl font-bold text-white mb-1">63/100</div>
            <div class="text-sm text-astro-gray-200">Score final</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-yellow-400 mb-1">D</div>
            <div class="text-sm text-astro-gray-200">Grade</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-orange-400 mb-1">1</div>
            <div class="text-sm text-astro-gray-200">Violation</div>
          </div>
          <div>
            <div class="text-3xl font-bold text-green-400 mb-1">29</div>
            <div class="text-sm text-astro-gray-200">Fichiers générés</div>
          </div>
        </div>

        <div class="mt-6 pt-6 border-t border-white/10">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <div class="text-sm text-astro-gray-200 mb-1">Hexagonal Architecture</div>
              <div class="text-2xl font-bold text-green-400">100%</div>
            </div>
            <div>
              <div class="text-sm text-astro-gray-200 mb-1">DDD Compliance</div>
              <div class="text-2xl font-bold text-green-400">95%</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Bilan -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy
        label="Bilan"
        title="Ce que révèle cette étape"
        gradient="bg-blue-purple-gradient"
      >
        Cette dernière étape valide le résultat complet de la migration.<br>
        Chaque carte ci-dessous résume un enseignement clé, issu directement des rapports HexaGlue.
      </SectionCopy>

      <div class="mt-10 grid gap-6 md:grid-cols-2">
        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:checkbox-circle-line" class="w-6 h-6 text-green-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">Infrastructure 100% générée</h3>
              <p class="text-sm text-astro-gray-200">
                L'application fonctionne de bout en bout avec toute l'infrastructure de persistance générée automatiquement.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:building-line" class="w-6 h-6 text-purple-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">Convention reconstitute()</h3>
              <p class="text-sm text-astro-gray-200">
                La méthode factory reconstitute() est essentielle pour que les mappers générés puissent restaurer les agrégats.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:fingerprint-line" class="w-6 h-6 text-blue-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">Identifiants UUID</h3>
              <p class="text-sm text-astro-gray-200">
                HexaGlue attend des identifiants UUID avec la stratégie ASSIGNED. La méthode generate() est requise.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:database-line" class="w-6 h-6 text-green-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">0 infrastructure manuelle</h3>
              <p class="text-sm text-astro-gray-200">
                Aucun code de persistance n'a été écrit manuellement. Tout est généré par HexaGlue.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:node-tree" class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">Refactoring InventoryUseCases</h3>
              <p class="text-sm text-astro-gray-200">
                Les services d'application orchestrent les agrégats directement via les driven ports plutôt que via des use cases intermédiaires.
              </p>
            </div>
          </div>
        </div>

        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:error-warning-line" class="w-6 h-6 text-orange-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">1 violation résiduelle</h3>
              <p class="text-sm text-astro-gray-200">
                OrderLine n'est pas classifié comme Entity en raison d'une limitation du classificateur (absence d'identifiant explicite).
              </p>
            </div>
          </div>
        </div>
      </div>

      <Insight class="mt-10">
        <p>En 6 étapes, le score est passé de <strong>13 à 63/100</strong> (+50 points) et l'application est fonctionnelle de bout en bout.</p>
        <ul>
          <li><strong>Architecture hexagonale à 100%</strong> : services applicatifs purifiés, chaque port dispose d'un adaptateur, les couches sont isolées</li>
          <li><strong>29 fichiers générés, 0 infrastructure manuelle</strong> : toute la persistance est produite au compile-time par HexaGlue</li>
          <li><strong>Conventions requises</strong> : <code>reconstitute()</code> pour restaurer les agrégats, <code>generate()</code> pour les identifiants UUID avec stratégie ASSIGNED</li>
          <li><strong>1 violation résiduelle</strong> : <code>OrderLine</code> sans identifiant explicite, limitation connue du classificateur</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- Axes d'amélioration -->
  <section class="py-16 md:py-20 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <SectionCopy label="Perspectives" title="Axes d'amélioration" gradient="bg-blue-purple-gradient">
        Le score de 63/100 (grade D) reflète fidèlement l'état du projet : l'architecture hexagonale est en place, mais des dimensions structurelles restent à travailler.<br>
        Voici les leviers identifiés par HexaGlue pour progresser vers les grades supérieurs.
      </SectionCopy>

      <div class="mt-10 space-y-6">
        <!-- Dependencies -->
        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:git-branch-line" class="w-6 h-6 text-red-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">Dependencies : 0% &rarr; cycles de dépendances</h3>
              <p class="text-sm text-astro-gray-200">
                Cette dimension pénalise les cycles de dépendances entre packages
                et les violations du principe de dépendances stables (SDP).
                Un score de 0% indique de nombreux cycles inter-packages dans le code classifié.
              </p>
              <p class="text-sm text-astro-gray-200 mt-2">
                <strong class="text-white">Levier</strong> : restructurer les packages pour éliminer
                les cycles de dépendances. Isoler chaque bounded context (Order, Customer, Product)
                dans des packages indépendants, ou migrer vers une structure multi-module
                pour forcer la séparation physique via <code>reactor-generate</code> et <code>reactor-audit</code>.
              </p>
            </div>
          </div>
        </div>

        <!-- Coupling -->
        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:links-line" class="w-6 h-6 text-orange-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">Coupling : 31% &rarr; restructuration</h3>
              <p class="text-sm text-astro-gray-200">
                Cette dimension mesure le couplage afférent entre packages.
                Plusieurs bounded contexts partagent des types, ce qui augmente le couplage.
              </p>
              <p class="text-sm text-astro-gray-200 mt-2">
                <strong class="text-white">Levier</strong> : réduire les dépendances croisées entre
                bounded contexts (Order, Customer, Product) en isolant davantage les packages.
              </p>
            </div>
          </div>
        </div>

        <!-- Violation résiduelle -->
        <div class="bg-astro-dark-800/40 border border-astro-dark-100/15 rounded-2xl p-6">
          <div class="flex items-start gap-3">
            <Icon name="ri:error-warning-line" class="w-6 h-6 text-yellow-400 flex-shrink-0 mt-1" />
            <div>
              <h3 class="text-lg font-semibold text-white mb-2">Violation aggregate-boundary</h3>
              <p class="text-sm text-astro-gray-200">
                <code>OrderLine</code> est accessible hors de l'agrégat <code>Order</code>
                car il n'a pas d'identifiant explicite.
                Ajouter un <code>OrderLineId</code> permettrait au classificateur de reconnaître
                <code>OrderLine</code> comme Entity membre de l'agrégat et d'éliminer cette violation.
              </p>
            </div>
          </div>
        </div>
      </div>

      <Insight variant="green" class="mt-10">
        <p><strong>Projection</strong> : en corrigeant Dependencies (multi-module) et Coupling (restructuration),
        le score pourrait atteindre 80+ (grade B).</p>
        <ul>
          <li><strong>Multi-module</strong> : HexaGlue supporte nativement les projets multi-modules
          via <code>reactor-generate</code> et <code>reactor-audit</code>.
          L'étude de cas Banking illustre cette approche</li>
          <li><strong>Boilerplate (81%)</strong> : ce ratio élevé reflète le volume de code généré
          (entités JPA, mappers), technique par nature. Il n'est pas un indicateur de dette</li>
          <li><strong>Plugins futurs</strong> : un plugin REST pourrait générer les contrôleurs,
          actuellement écrits manuellement</li>
        </ul>
      </Insight>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="py-16 md:py-24 mb-12 relative">
    <div class="w-full max-w-screen-xl mx-auto px-4 sm:px-8 text-center space-y-6">
      <h2 class="font-heading heading-bold text-3xl md:text-4xl lg:text-5xl text-white">
        <span class="text-astro-gray-300">Une architecture hexagonale opérationnelle.</span><br/>
        <span class="bg-clip-text text-transparent bg-blue-purple-gradient">Un socle solide pour aller plus loin.</span>
      </h2>

      <p class="text-xl text-astro-gray-200 font-light max-w-2xl mx-auto">
        Un domaine pur, des adaptateurs générés, et une feuille de route claire vers un grade B.
      </p>

      <div class="pt-4 flex flex-col sm:flex-row items-center justify-center gap-4">
        <a
          href="/docs/getting-started/"
          class="px-6 py-3 group inline-flex items-center justify-center gap-2 rounded-full border border-transparent bg-white hover:bg-astro-gray-100 text-base font-medium transition-all ease-in-out duration-300"
        >
          <span class="bg-clip-text text-transparent bg-blue-purple-gradient group-hover:text-[#4c3a9e] transition-all ease-in-out duration-500">
            Guide de démarrage
          </span>
          <Icon name="ri:guide-line" class="size-5 text-purple-500" aria-hidden="true" />
        </a>
        <Link href="/case-studies/ecommerce-migration/" class="secondary">
          <Icon name="ri:arrow-left-line" class="size-5" aria-hidden="true" />
          <span>Vue d'ensemble</span>
        </Link>
      </div>
    </div>
    <div
      class="absolute inset-x-0 bottom-0 h-[50vw] translate-y-[60%] bg-blue-purple-gradient opacity-50 mask-radial-gradient pointer-events-none"
    ></div>
  </section>

  <!-- Step Navigation -->
  <section class="py-16 relative w-full max-w-4xl mx-auto px-4 sm:px-8">
    <div class="max-w-5xl mx-auto">
      <StepNavigation
        prev={{ href: '/case-studies/ecommerce-migration/step-5-generated/', label: 'Étape 5 - Génération automatique de l\'infrastructure' }}
      />
    </div>
  </section>
</MainLayout>
