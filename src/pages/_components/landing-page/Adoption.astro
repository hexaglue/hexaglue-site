---
import SectionCopy from '../SectionCopy.astro';
import PurpleStardust from './PurpleStardust.astro';
import AdoptionStep from './AdoptionStep.astro';
import AdoptionPanel from './AdoptionPanel.astro';
import FeatureCard from './feature-cards/FeatureCard.astro';
---

<section class="mt-20 md:mt-24 lg:mt-28 xl:mt-36 relative">
	<div class="w-full max-w-screen-xl mx-auto px-4 sm:px-8">
		<SectionCopy
			label="Adoption"
			title="Une Adoption Progressive, Sans Risque"
			description="Avec HexaGlue, avancez à votre rythme. Observez, verrouillez, automatisez, sans jamais vous enfermer."
		/>

		<div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
			<FeatureCard
				icon="ri/timer-flash-line"
				title="Aucune contrainte de runtime"
				description="HexaGlue agit uniquement à la compilation. Rien n'est embarqué en production. Vous pouvez vous arrêter à tout moment, sans dette technique."
			/>
			<FeatureCard
				icon="ri/code-s-slash-line"
				title="Aucun framework imposé"
				description="Votre code reste le vôtre. Vos choix technologiques restent ouverts. Pas de dépendance cachée, pas de marche arrière coûteuse."
			/>
			<FeatureCard
				icon="bi/shield-lock"
				title="Aucun vendor lock-in"
				description="Les modèles, les règles et le code généré vous appartiennent. Reprenez le contrôle de votre architecture, étape par étape."
			/>
		</div>
	</div>

	<div class="mx-auto w-full max-w-screen-xl">
		<div
			role="tablist"
			aria-label="Étapes d'adoption"
			class="mt-4 py-1 sm:mt-8 px-4 sm:px-8 w-full flex items-center overflow-x-auto whitespace-nowrap no-scrollbar gap-4"
		>
			<AdoptionStep number={1} label="Observer" isActive />
			<AdoptionStep number={2} label="Gouverner" />
			<AdoptionStep number={3} label="Accélérer" />
		</div>
	</div>

	<PurpleStardust height="h-64 lg:h-80 xl:h-96" />

	<div class="my-4 w-full border-t border-t-astro-gray-600"></div>

	<div class="mx-auto w-full max-w-screen-xl px-4 sm:px-8">
		<AdoptionPanel
			id="1"
			tab="observer"
			icon="ri/eye-line"
			title="Observer"
			description="Construisez le modèle, obtenez la classification, générez la living documentation."
			features={[
				'Classification automatique du domaine',
				'Génération de documentation synchronisée',
				'Visualisation de l\'architecture existante',
			]}
		/>
		<AdoptionPanel
			id="2"
			tab="gouverner"
			class="hidden"
			icon="ri/compass-line"
			title="Gouverner"
			description="Activez l'audit et la validation en CI : les invariants deviennent des contrôles."
			features={[
				'Validation des règles architecturales',
				'Audit automatique en CI/CD',
				'Détection des violations avant déploiement',
			]}
		/>
		<AdoptionPanel
			id="3"
			tab="accelerer"
			class="hidden"
			icon="bi/rocket-takeoff-fill"
			title="Accélérer"
			description="Branchez la génération d'infrastructure : standardisez et industrialisez."
			features={[
				'Génération automatique des entités JPA',
				'Création des repositories',
				'Production de code d\'infrastructure aligné',
			]}
		/>
	</div>
</section>

<script>
	const tabs = document.querySelectorAll('.adoption-tab');
	let activeTabIndex = 0;
	let autoPlayInterval: ReturnType<typeof setInterval> | null = null;
	const AUTO_PLAY_DELAY = 4000; // 4 seconds per tab

	function updateTabStyles(tab: Element, isActive: boolean) {
		const numberBadge = tab.querySelector('span:first-child');

		if (isActive) {
			tab.classList.remove('bg-astro-dark-800/30', 'border-astro-dark-100/20', 'text-astro-gray-200');
			tab.classList.add('bg-blue-green-gradient/10', 'border-astro-green/30', 'text-white');
			numberBadge?.classList.remove('bg-astro-dark-100/30', 'text-astro-gray-200');
			numberBadge?.classList.add('bg-astro-green', 'text-black');
		} else {
			tab.classList.remove('bg-blue-green-gradient/10', 'border-astro-green/30', 'text-white');
			tab.classList.add('bg-astro-dark-800/30', 'border-astro-dark-100/20', 'text-astro-gray-200');
			numberBadge?.classList.remove('bg-astro-green', 'text-black');
			numberBadge?.classList.add('bg-astro-dark-100/30', 'text-astro-gray-200');
		}
	}

	function updateTabSelection(index: number, shouldFocus: boolean = false) {
		const nextTab = tabs[index];
		const activeTab = tabs[activeTabIndex];
		const nextTabContent = document.querySelector(`#adoption-panel-${index + 1}`);
		const activeTabContent = document.querySelector(`#adoption-panel-${activeTabIndex + 1}`);

		if (!nextTab || !activeTab || !nextTabContent || !activeTabContent) return;

		// Update ARIA attributes
		activeTab.setAttribute('aria-selected', 'false');
		activeTab.setAttribute('tabindex', '-1');
		activeTabContent.classList.add('hidden');

		nextTab.setAttribute('aria-selected', 'true');
		nextTab.setAttribute('tabindex', '0');
		nextTabContent.classList.remove('hidden');

		// Update visual styles
		updateTabStyles(activeTab, false);
		updateTabStyles(nextTab, true);

		if (shouldFocus) {
			(tabs[index] as HTMLElement).focus();
		}
		activeTabIndex = index;
	}

	function startAutoPlay() {
		if (autoPlayInterval) return;
		autoPlayInterval = setInterval(() => {
			const nextIndex = (activeTabIndex + 1) % tabs.length;
			updateTabSelection(nextIndex, false);
		}, AUTO_PLAY_DELAY);
	}

	function stopAutoPlay() {
		if (autoPlayInterval) {
			clearInterval(autoPlayInterval);
			autoPlayInterval = null;
		}
	}

	function restartAutoPlay() {
		stopAutoPlay();
		startAutoPlay();
	}

	tabs.forEach((tab, index) => {
		tab.addEventListener('click', () => {
			updateTabSelection(index, true);
			restartAutoPlay(); // Reset timer on manual interaction
		});

		tab.addEventListener('keydown', (e) => {
			const event = e as KeyboardEvent;
			if (event.key === 'ArrowRight') {
				event.preventDefault();
				const nextIndex = (activeTabIndex + 1) % tabs.length;
				updateTabSelection(nextIndex, true);
				restartAutoPlay();
			} else if (event.key === 'ArrowLeft') {
				event.preventDefault();
				const prevIndex = (activeTabIndex - 1 + tabs.length) % tabs.length;
				updateTabSelection(prevIndex, true);
				restartAutoPlay();
			}
		});
	});

	// Start auto-play
	startAutoPlay();
</script>
